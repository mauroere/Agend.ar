"use strict";(()=>{var e={};e.id=9689,e.ids=[9689],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8280:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>S,patchFetch:()=>b,requestAsyncStorage:()=>h,routeModule:()=>w,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y});var n={};a.r(n),a.d(n,{GET:()=>g});var i=a(9303),r=a(8716),o=a(670),s=a(7070),d=a(4730),l=a(3229),c=a(5072),p=a(836),u=a(59),m=a(6651),_=a(40);async function f(){if(!c.o)throw Error("Supabase service client unavailable");let e=(0,l.T)(new Date,48).toISOString(),{data:t}=await c.o.from("agenda_appointments").select("id, tenant_id, location_id, start_at").eq("status","canceled").gte("updated_at",new Date(Date.now()-3e5).toISOString()).lte("start_at",e);(0,_.PN)("waitlist.canceled_found",{job:"waitlist",payload:{count:t?.length??0}});let a=new Map,n=new Map,i=u.g.waitlistOffer;for(let e of t??[]){let[t,r]=await Promise.all([(async()=>(a.has(e.tenant_id)||a.set(e.tenant_id,await (0,m.XW)(c.o,e.tenant_id)),a.get(e.tenant_id)??null))(),(async()=>(n.has(e.tenant_id)||n.set(e.tenant_id,await (0,m.OC)(c.o,e.tenant_id)),n.get(e.tenant_id)))()]);if(!t){(0,_.H)("waitlist.missing_credentials",{job:"waitlist",tenant_id:e.tenant_id,appointment_id:e.id});continue}let o=r?.get(i)?.metaTemplateName??null,{data:s}=await c.o.from("agenda_waitlist").select("id, patient_id, priority, agenda_patients:patient_id(id, full_name, phone_e164, opt_out)").eq("location_id",e.location_id).eq("tenant_id",e.tenant_id).eq("active",!0).order("priority",{ascending:!0}).limit(10);for(let a of s??[]){let n=a.agenda_patients;if(!n||n.opt_out)continue;let{data:r}=await c.o.from("agenda_message_log").select("id").eq("appointment_id",e.id).eq("patient_id",n.id).eq("type",u.g.waitlistOffer).maybeSingle();if(!r)try{await (0,p.D)({to:n.phone_e164,template:i,variables:[new Date(e.start_at).toLocaleDateString("es-AR"),new Date(e.start_at).toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"})],nameOverride:o,credentials:t}),await c.o.from("agenda_message_log").insert({tenant_id:e.tenant_id,patient_id:n.id,appointment_id:e.id,direction:"out",type:i,status:"sent"}),(0,_.PN)("waitlist.sent",{job:"waitlist",tenant_id:e.tenant_id,appointment_id:e.id,patient_id:n.id})}catch(t){(0,_.H)("waitlist.failed",{job:"waitlist",tenant_id:e.tenant_id,appointment_id:e.id,patient_id:n.id,error:t?.message??String(t)})}}}}async function g(e){try{return(0,d.r)(e.headers),await f(),s.NextResponse.json({ok:!0})}catch(e){return console.error(e),s.NextResponse.json({ok:!1,error:String(e)},{status:500})}}let w=new i.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/cron/waitlist/route",pathname:"/api/cron/waitlist",filename:"route",bundlePath:"app/api/cron/waitlist/route"},resolvedPagePath:"C:\\Users\\rementeriama\\Downloads\\Code\\Agend.ar\\src\\app\\api\\cron\\waitlist\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:v}=w,S="/api/cron/waitlist/route";function b(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},3405:(e,t,a)=>{a.d(t,{kA:()=>i,lD:()=>n});let n=["pending","confirmed","reschedule_requested","canceled","completed","no_show"],i="x-cron-secret"},4730:(e,t,a)=>{a.d(t,{r:()=>i});var n=a(3405);function i(e){let t=process.env.CRON_SECRET;if(!t)throw Error("CRON_SECRET is not configured");if(e.get(n.kA)!==t)throw Error("Invalid cron secret")}},40:(e,t,a)=>{function n(e,t,a={}){let n={level:e,message:t,timestamp:new Date().toISOString(),...a};return console["error"===e?"error":"warn"===e?"warn":"log"](JSON.stringify(n)),n}function i(e,t){return n("info",e,t)}function r(e,t){return n("error",e,t)}a.d(t,{H:()=>r,PN:()=>i})},59:(e,t,a)=>{a.d(t,{Q:()=>i,g:()=>n});let n={appointmentCreated:"appointment_created",reminder24h:"reminder_24h",reminder2h:"reminder_2h",waitlistOffer:"waitlist_offer"},i={[n.appointmentCreated]:"Hola {{1}}, agendamos tu turno para {{2}} a las {{3}} en {{4}}. Respond\xe9 1 Confirmar \xb7 2 Reprogramar \xb7 3 Cancelar \xb7 STOP para salir.",[n.reminder24h]:"Recordatorio {{1}} ma\xf1ana {{2}}. Respond\xe9 1 Confirmar \xb7 2 Reprogramar \xb7 3 Cancelar \xb7 STOP.",[n.reminder2h]:"Nos vemos hoy {{1}} a las {{2}}. Si necesit\xe1s moverlo respond\xe9 2, cancelar 3.",[n.waitlistOffer]:"Se liber\xf3 un turno {{1}} a las {{2}}. Respond\xe9 SI para tomarlo o STOP para salir."}},5072:(e,t,a)=>{a.d(t,{o:()=>o});var n=a(7857);let i="https://oaxielrsiogvnxradtsw.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;i&&r||console.warn("Supabase service client is not fully configured.");let o=i&&r?(0,n.eI)(i,r,{auth:{persistSession:!1}}):null},836:(e,t,a)=>{a.d(t,{D:()=>o,n:()=>s});var n=a(1067);let i=n.Ry({name:n.Z_(),language:n.Ry({code:n.Z_()}),components:n.IX(n.Yj()).optional()});async function r({credentials:e,path:t,init:a}){let{accessToken:n,phoneNumberId:i}=e;if(!n||!i)throw Error("WhatsApp credentials missing");let r=await fetch(`https://graph.facebook.com/v18.0/${i}/${t}`,{...a,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`,...a.headers}});if(!r.ok){let e=await r.text();throw Error(`WhatsApp API error: ${r.status} ${e}`)}return r.json()}async function o({to:e,template:t,variables:a=[],languageCode:n="es",nameOverride:o,credentials:s}){return r({credentials:s,path:"messages",init:{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"template",template:{...i.parse({name:o??t,language:{code:n}}),components:[{type:"body",parameters:a.map(e=>({type:"text",text:e}))}]}})}})}async function s({to:e,text:t,credentials:a}){return r({credentials:a,path:"messages",init:{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"text",text:{body:t}})}})}},6651:(e,t,a)=>{a.d(t,{$2:()=>s,OC:()=>l,XW:()=>o,gQ:()=>d});let n="meta_whatsapp";function i(e){if(!e||"object"!=typeof e)return null;let t="string"==typeof e.phoneNumberId?e.phoneNumberId:void 0,a="string"==typeof e.accessToken?e.accessToken:void 0,n="string"==typeof e.businessAccountId?e.businessAccountId:null,i="string"==typeof e.verifyToken?e.verifyToken:null;return t&&a?{phoneNumberId:t,accessToken:a,businessAccountId:n,verifyToken:i}:null}async function r(e,t){let a=e.from("agenda_integrations").select("id, tenant_id, provider, credentials, created_at, updated_at").eq("provider",n).limit(1);for(let[e,n]of Object.entries(t))a=a.filter(e,"eq",n);let{data:r,error:o}=await a.maybeSingle();if(o||!r)return null;let s=i(r.credentials);return s?{...r,credentials_parsed:s}:null}async function o(e,t){let a=await e.from("agenda_integrations").select("tenant_id, provider, credentials, created_at, updated_at").eq("tenant_id",t).eq("provider",n).maybeSingle();return a.error||!a.data?null:i(a.data.credentials)}async function s(e,t){let a=await r(e,{"credentials->>phoneNumberId":t});return a?{tenantId:a.tenant_id,credentials:a.credentials_parsed}:null}async function d(e,t){let a=await r(e,{"credentials->>verifyToken":t});return a?{tenantId:a.tenant_id,credentials:a.credentials_parsed}:null}async function l(e,t){let a=new Map,{data:n}=await e.from("agenda_message_templates").select("name, meta_template_name, status").eq("tenant_id",t);for(let e of n??[])a.set(e.name,{metaTemplateName:e.meta_template_name,status:e.status});return a}},3229:(e,t,a)=>{a.d(t,{T:()=>r});var n=a(1459),i=a(2313);function r(e,t){return(0,n.n)(e,t*i.vh)}},1459:(e,t,a)=>{a.d(t,{n:()=>r});var n=a(9109),i=a(4549);function r(e,t){let a=+(0,n.Q)(e);return(0,i.L)(e,a+t)}},2313:(e,t,a)=>{a.d(t,{dP:()=>i,jE:()=>n,vh:()=>o,yJ:()=>r});let n=6048e5,i=864e5,r=6e4,o=36e5},4549:(e,t,a)=>{function n(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}a.d(t,{L:()=>n})},9109:(e,t,a)=>{function n(e){let t=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===t?new e.constructor(+e):new Date("number"==typeof e||"[object Number]"===t||"string"==typeof e||"[object String]"===t?e:NaN)}a.d(t,{Q:()=>n})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[9276,7857,5972,1067],()=>a(8280));module.exports=n})();