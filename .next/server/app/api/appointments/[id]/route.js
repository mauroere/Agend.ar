"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/appointments/[id]/route";
exports.ids = ["app/api/appointments/[id]/route"];
exports.modules = {

/***/ "../../client/components/action-async-storage.external":
/*!*******************************************************************************!*\
  !*** external "next/dist/client/components/action-async-storage.external.js" ***!
  \*******************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/action-async-storage.external.js");

/***/ }),

/***/ "../../client/components/request-async-storage.external":
/*!********************************************************************************!*\
  !*** external "next/dist/client/components/request-async-storage.external.js" ***!
  \********************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/request-async-storage.external.js");

/***/ }),

/***/ "../../client/components/static-generation-async-storage.external":
/*!******************************************************************************************!*\
  !*** external "next/dist/client/components/static-generation-async-storage.external.js" ***!
  \******************************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/static-generation-async-storage.external.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "buffer":
/*!*************************!*\
  !*** external "buffer" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("buffer");

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fappointments%2F%5Bid%5D%2Froute&page=%2Fapi%2Fappointments%2F%5Bid%5D%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fappointments%2F%5Bid%5D%2Froute.ts&appDir=C%3A%5CUsers%5Crementeriama%5CDownloads%5CCode%5CAgend.ar%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Crementeriama%5CDownloads%5CCode%5CAgend.ar&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!*************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fappointments%2F%5Bid%5D%2Froute&page=%2Fapi%2Fappointments%2F%5Bid%5D%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fappointments%2F%5Bid%5D%2Froute.ts&appDir=C%3A%5CUsers%5Crementeriama%5CDownloads%5CCode%5CAgend.ar%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Crementeriama%5CDownloads%5CCode%5CAgend.ar&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \*************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var C_Users_rementeriama_Downloads_Code_Agend_ar_src_app_api_appointments_id_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./src/app/api/appointments/[id]/route.ts */ \"(rsc)/./src/app/api/appointments/[id]/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/appointments/[id]/route\",\n        pathname: \"/api/appointments/[id]\",\n        filename: \"route\",\n        bundlePath: \"app/api/appointments/[id]/route\"\n    },\n    resolvedPagePath: \"C:\\\\Users\\\\rementeriama\\\\Downloads\\\\Code\\\\Agend.ar\\\\src\\\\app\\\\api\\\\appointments\\\\[id]\\\\route.ts\",\n    nextConfigOutput,\n    userland: C_Users_rementeriama_Downloads_Code_Agend_ar_src_app_api_appointments_id_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/appointments/[id]/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZhcHBvaW50bWVudHMlMkYlNUJpZCU1RCUyRnJvdXRlJnBhZ2U9JTJGYXBpJTJGYXBwb2ludG1lbnRzJTJGJTVCaWQlNUQlMkZyb3V0ZSZhcHBQYXRocz0mcGFnZVBhdGg9cHJpdmF0ZS1uZXh0LWFwcC1kaXIlMkZhcGklMkZhcHBvaW50bWVudHMlMkYlNUJpZCU1RCUyRnJvdXRlLnRzJmFwcERpcj1DJTNBJTVDVXNlcnMlNUNyZW1lbnRlcmlhbWElNUNEb3dubG9hZHMlNUNDb2RlJTVDQWdlbmQuYXIlNUNzcmMlNUNhcHAmcGFnZUV4dGVuc2lvbnM9dHN4JnBhZ2VFeHRlbnNpb25zPXRzJnBhZ2VFeHRlbnNpb25zPWpzeCZwYWdlRXh0ZW5zaW9ucz1qcyZyb290RGlyPUMlM0ElNUNVc2VycyU1Q3JlbWVudGVyaWFtYSU1Q0Rvd25sb2FkcyU1Q0NvZGUlNUNBZ2VuZC5hciZpc0Rldj10cnVlJnRzY29uZmlnUGF0aD10c2NvbmZpZy5qc29uJmJhc2VQYXRoPSZhc3NldFByZWZpeD0mbmV4dENvbmZpZ091dHB1dD0mcHJlZmVycmVkUmVnaW9uPSZtaWRkbGV3YXJlQ29uZmlnPWUzMCUzRCEiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQXNHO0FBQ3ZDO0FBQ2M7QUFDK0M7QUFDNUg7QUFDQTtBQUNBO0FBQ0Esd0JBQXdCLGdIQUFtQjtBQUMzQztBQUNBLGNBQWMseUVBQVM7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLFlBQVk7QUFDWixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0EsUUFBUSxpRUFBaUU7QUFDekU7QUFDQTtBQUNBLFdBQVcsNEVBQVc7QUFDdEI7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUN1SDs7QUFFdkgiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hZ2VuZGFyLWFwcC8/NDcwNyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBSb3V0ZVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCJDOlxcXFxVc2Vyc1xcXFxyZW1lbnRlcmlhbWFcXFxcRG93bmxvYWRzXFxcXENvZGVcXFxcQWdlbmQuYXJcXFxcc3JjXFxcXGFwcFxcXFxhcGlcXFxcYXBwb2ludG1lbnRzXFxcXFtpZF1cXFxccm91dGUudHNcIjtcbi8vIFdlIGluamVjdCB0aGUgbmV4dENvbmZpZ091dHB1dCBoZXJlIHNvIHRoYXQgd2UgY2FuIHVzZSB0aGVtIGluIHRoZSByb3V0ZVxuLy8gbW9kdWxlLlxuY29uc3QgbmV4dENvbmZpZ091dHB1dCA9IFwiXCJcbmNvbnN0IHJvdXRlTW9kdWxlID0gbmV3IEFwcFJvdXRlUm91dGVNb2R1bGUoe1xuICAgIGRlZmluaXRpb246IHtcbiAgICAgICAga2luZDogUm91dGVLaW5kLkFQUF9ST1VURSxcbiAgICAgICAgcGFnZTogXCIvYXBpL2FwcG9pbnRtZW50cy9baWRdL3JvdXRlXCIsXG4gICAgICAgIHBhdGhuYW1lOiBcIi9hcGkvYXBwb2ludG1lbnRzL1tpZF1cIixcbiAgICAgICAgZmlsZW5hbWU6IFwicm91dGVcIixcbiAgICAgICAgYnVuZGxlUGF0aDogXCJhcHAvYXBpL2FwcG9pbnRtZW50cy9baWRdL3JvdXRlXCJcbiAgICB9LFxuICAgIHJlc29sdmVkUGFnZVBhdGg6IFwiQzpcXFxcVXNlcnNcXFxccmVtZW50ZXJpYW1hXFxcXERvd25sb2Fkc1xcXFxDb2RlXFxcXEFnZW5kLmFyXFxcXHNyY1xcXFxhcHBcXFxcYXBpXFxcXGFwcG9pbnRtZW50c1xcXFxbaWRdXFxcXHJvdXRlLnRzXCIsXG4gICAgbmV4dENvbmZpZ091dHB1dCxcbiAgICB1c2VybGFuZFxufSk7XG4vLyBQdWxsIG91dCB0aGUgZXhwb3J0cyB0aGF0IHdlIG5lZWQgdG8gZXhwb3NlIGZyb20gdGhlIG1vZHVsZS4gVGhpcyBzaG91bGRcbi8vIGJlIGVsaW1pbmF0ZWQgd2hlbiB3ZSd2ZSBtb3ZlZCB0aGUgb3RoZXIgcm91dGVzIHRvIHRoZSBuZXcgZm9ybWF0LiBUaGVzZVxuLy8gYXJlIHVzZWQgdG8gaG9vayBpbnRvIHRoZSByb3V0ZS5cbmNvbnN0IHsgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MgfSA9IHJvdXRlTW9kdWxlO1xuY29uc3Qgb3JpZ2luYWxQYXRobmFtZSA9IFwiL2FwaS9hcHBvaW50bWVudHMvW2lkXS9yb3V0ZVwiO1xuZnVuY3Rpb24gcGF0Y2hGZXRjaCgpIHtcbiAgICByZXR1cm4gX3BhdGNoRmV0Y2goe1xuICAgICAgICBzZXJ2ZXJIb29rcyxcbiAgICAgICAgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZVxuICAgIH0pO1xufVxuZXhwb3J0IHsgcm91dGVNb2R1bGUsIHJlcXVlc3RBc3luY1N0b3JhZ2UsIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzLCBvcmlnaW5hbFBhdGhuYW1lLCBwYXRjaEZldGNoLCAgfTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YXBwLXJvdXRlLmpzLm1hcCJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fappointments%2F%5Bid%5D%2Froute&page=%2Fapi%2Fappointments%2F%5Bid%5D%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fappointments%2F%5Bid%5D%2Froute.ts&appDir=C%3A%5CUsers%5Crementeriama%5CDownloads%5CCode%5CAgend.ar%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Crementeriama%5CDownloads%5CCode%5CAgend.ar&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./src/app/api/appointments/[id]/route.ts":
/*!************************************************!*\
  !*** ./src/app/api/appointments/[id]/route.ts ***!
  \************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   PATCH: () => (/* binding */ PATCH)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var _barrel_optimize_names_addMinutes_differenceInMinutes_date_fns__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! __barrel_optimize__?names=addMinutes,differenceInMinutes!=!date-fns */ \"(rsc)/./node_modules/date-fns/differenceInMinutes.mjs\");\n/* harmony import */ var _barrel_optimize_names_addMinutes_differenceInMinutes_date_fns__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! __barrel_optimize__?names=addMinutes,differenceInMinutes!=!date-fns */ \"(rsc)/./node_modules/date-fns/addMinutes.mjs\");\n/* harmony import */ var _lib_scheduling__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @/lib/scheduling */ \"(rsc)/./src/lib/scheduling.ts\");\n/* harmony import */ var _lib_supabase_route__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/supabase/route */ \"(rsc)/./src/lib/supabase/route.ts\");\n/* harmony import */ var _lib_supabase_service__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @/lib/supabase/service */ \"(rsc)/./src/lib/supabase/service.ts\");\n/* harmony import */ var _server_tenant_headers__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! @/server/tenant-headers */ \"(rsc)/./src/server/tenant-headers.ts\");\n\n\n\n\n\n\nasync function PATCH(request, { params }) {\n    const supabase = (0,_lib_supabase_route__WEBPACK_IMPORTED_MODULE_2__.getRouteSupabase)();\n    const { data: auth } = await supabase.auth.getSession();\n    const tokenTenant = auth.session?.user?.app_metadata?.tenant_id ?? auth.session?.user?.user_metadata?.tenant_id ?? null;\n    const headerInfo = (0,_server_tenant_headers__WEBPACK_IMPORTED_MODULE_4__.getTenantHeaderInfo)(request.headers);\n    const tenantId = tokenTenant ?? headerInfo.internalId;\n    if (!auth.session || !tenantId) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Unauthorized\"\n        }, {\n            status: 401\n        });\n    }\n    if (headerInfo.internalId && tokenTenant && headerInfo.internalId !== tokenTenant && !headerInfo.isDevBypass) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Tenant mismatch\"\n        }, {\n            status: 403\n        });\n    }\n    // Use serviceClient for DB operations to bypass RLS in dev/mismatch scenarios\n    const db = _lib_supabase_service__WEBPACK_IMPORTED_MODULE_3__.serviceClient ?? supabase;\n    const appointmentId = params.id;\n    if (!appointmentId) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Missing appointment id\"\n        }, {\n            status: 400\n        });\n    }\n    const body = await request.json();\n    const { patient, phone, start, duration, service, notes, location_id, serviceId, providerId } = body ?? {};\n    const payload = body ?? {};\n    const hasServiceId = Object.prototype.hasOwnProperty.call(payload, \"serviceId\");\n    const hasProviderId = Object.prototype.hasOwnProperty.call(payload, \"providerId\");\n    if (!patient || !phone || !start) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Faltan datos requeridos\"\n        }, {\n            status: 400\n        });\n    }\n    const { data: existingAppt, error: fetchError } = await db.from(\"agenda_appointments\").select(\"id, tenant_id, location_id, start_at, end_at, status, patient_id, service_name\" // Removed provider_id, service_id, snapshot\n    ).eq(\"id\", appointmentId).eq(\"tenant_id\", tenantId).single();\n    const typedExisting = existingAppt;\n    if (fetchError || !typedExisting) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Turno no encontrado\"\n        }, {\n            status: 404\n        });\n    }\n    const startAt = new Date(start);\n    if (!Number.isFinite(startAt.getTime())) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Fecha inv\\xe1lida\"\n        }, {\n            status: 400\n        });\n    }\n    const existingDuration = (0,_barrel_optimize_names_addMinutes_differenceInMinutes_date_fns__WEBPACK_IMPORTED_MODULE_5__.differenceInMinutes)(new Date(typedExisting.end_at), new Date(typedExisting.start_at));\n    const normalizedPhone = phone.startsWith(\"+\") ? phone : `+${phone}`;\n    // PATCH: DB columns missing\n    const nextServiceId = hasServiceId ? serviceId ?? null : null; // typedExisting.service_id ?? null;\n    let resolvedService = null;\n    if (nextServiceId) {\n        const { data: serviceRow, error: serviceError } = await db.from(\"agenda_services\").select(\"id, tenant_id, name, description, duration_minutes, price_minor_units, currency, color, active\").eq(\"tenant_id\", tenantId).eq(\"id\", nextServiceId).maybeSingle();\n        if (serviceError || !serviceRow) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Servicio inv\\xe1lido\"\n            }, {\n                status: 400\n            });\n        }\n        if (!serviceRow.active) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"El servicio est\\xe1 pausado\"\n            }, {\n                status: 400\n            });\n        }\n        resolvedService = serviceRow;\n    }\n    const nextProviderId = hasProviderId ? providerId ?? null : null;\n    let resolvedProvider = null;\n    if (nextProviderId) {\n        const { data: providerRow, error: providerError } = await db.from(\"agenda_providers\").select(\"id, tenant_id, full_name, active, default_location_id, metadata\").eq(\"tenant_id\", tenantId).eq(\"id\", nextProviderId).maybeSingle();\n        if (providerError || !providerRow) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Profesional inv\\xe1lido\"\n            }, {\n                status: 400\n            });\n        }\n        if (!providerRow.active) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"El profesional est\\xe1 pausado\"\n            }, {\n                status: 400\n            });\n        }\n        resolvedProvider = providerRow;\n    }\n    const durationSource = Number(duration ?? resolvedService?.duration_minutes ?? existingDuration ?? 30);\n    const durationMinutes = Math.max(5, Number.isFinite(durationSource) ? durationSource : existingDuration || 30);\n    const endAt = (0,_barrel_optimize_names_addMinutes_differenceInMinutes_date_fns__WEBPACK_IMPORTED_MODULE_6__.addMinutes)(startAt, durationMinutes);\n    const { data: existingPatient } = await db.from(\"agenda_patients\").select(\"id\").eq(\"tenant_id\", tenantId).eq(\"phone_e164\", normalizedPhone).maybeSingle();\n    const typedPatient = existingPatient;\n    let patientId = typedPatient?.id ?? typedExisting.patient_id ?? null;\n    if (!patientId) {\n        const patientInsert = {\n            tenant_id: tenantId,\n            full_name: patient,\n            phone_e164: normalizedPhone,\n            opt_out: false\n        };\n        const { data: inserted, error: patientError } = await db.from(\"agenda_patients\").insert(patientInsert).select(\"id\").single();\n        if (patientError) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: patientError.message\n        }, {\n            status: 400\n        });\n        patientId = inserted.id;\n    } else {\n        await db.from(\"agenda_patients\").update({\n            full_name: patient\n        }).eq(\"id\", patientId).eq(\"tenant_id\", tenantId);\n    }\n    let locationId = location_id ?? typedExisting.location_id ?? resolvedProvider?.default_location_id ?? null;\n    let locationTimezone = \"America/Argentina/Buenos_Aires\";\n    let bufferMinutes = 0;\n    let businessHours = {};\n    if (locationId) {\n        const { data: locationRow } = await db.from(\"agenda_locations\").select(\"id, timezone, buffer_minutes, business_hours\").eq(\"tenant_id\", tenantId).eq(\"id\", locationId).maybeSingle();\n        const typedLocation = locationRow;\n        if (typedLocation) {\n            locationTimezone = typedLocation.timezone;\n            bufferMinutes = typedLocation.buffer_minutes ?? 0;\n            businessHours = typedLocation.business_hours ?? {};\n        }\n    }\n    if (!locationId) {\n        const { data: fallback } = await db.from(\"agenda_locations\").select(\"id, timezone, buffer_minutes, business_hours\").eq(\"tenant_id\", tenantId).order(\"name\", {\n            ascending: true\n        }).limit(1).maybeSingle();\n        const typedFallback = fallback;\n        if (typedFallback) {\n            locationId = typedFallback.id;\n            locationTimezone = typedFallback.timezone;\n            bufferMinutes = typedFallback.buffer_minutes ?? 0;\n            businessHours = typedFallback.business_hours ?? {};\n        }\n    }\n    if (!locationId) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Debe crear una ubicaci\\xf3n primero\"\n        }, {\n            status: 400\n        });\n    }\n    // 1. Check Provider Override (similar to createAppointment)\n    if (resolvedProvider) {\n        const provSchedule = resolvedProvider.metadata?.schedule;\n        if (provSchedule && Object.keys(provSchedule).length > 0) {\n            businessHours = provSchedule;\n        }\n    }\n    // 2. Fallback default hours if empty\n    if (Object.keys(businessHours).length === 0) {\n        businessHours = {\n            mon: [\n                [\n                    \"09:00\",\n                    \"18:00\"\n                ]\n            ],\n            tue: [\n                [\n                    \"09:00\",\n                    \"18:00\"\n                ]\n            ],\n            wed: [\n                [\n                    \"09:00\",\n                    \"18:00\"\n                ]\n            ],\n            thu: [\n                [\n                    \"09:00\",\n                    \"18:00\"\n                ]\n            ],\n            fri: [\n                [\n                    \"09:00\",\n                    \"18:00\"\n                ]\n            ]\n        };\n    }\n    const validHours = (0,_lib_scheduling__WEBPACK_IMPORTED_MODULE_1__.isWithinBusinessHours)({\n        start: startAt,\n        end: endAt,\n        businessHours,\n        timeZone: locationTimezone\n    });\n    if (!validHours) {\n        const debugInfo = `Start: ${startAt.toISOString()}, LocTZ: ${locationTimezone}, LocalDay: ${new Intl.DateTimeFormat(\"en-US\", {\n            timeZone: locationTimezone,\n            weekday: \"short\",\n            hour: \"numeric\"\n        }).format(startAt)}`;\n        console.error(`[AppointmentPatchError] Outside Business Hours. ${debugInfo}`);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: `Fuera del horario de atenciÃ³n (${debugInfo})`\n        }, {\n            status: 400\n        });\n    }\n    const conflictWindowStart = (0,_barrel_optimize_names_addMinutes_differenceInMinutes_date_fns__WEBPACK_IMPORTED_MODULE_6__.addMinutes)(startAt, -bufferMinutes);\n    const conflictWindowEnd = (0,_barrel_optimize_names_addMinutes_differenceInMinutes_date_fns__WEBPACK_IMPORTED_MODULE_6__.addMinutes)(endAt, bufferMinutes);\n    let conflictQuery = db.from(\"agenda_appointments\").select(\"id\").eq(\"tenant_id\", tenantId).eq(\"location_id\", locationId).neq(\"status\", \"canceled\").neq(\"id\", appointmentId).lt(\"start_at\", conflictWindowEnd.toISOString()).gt(\"end_at\", conflictWindowStart.toISOString());\n    /*\r\n  if (nextProviderId) {\r\n    conflictQuery = conflictQuery.or(`provider_id.eq.${nextProviderId},provider_id.is.null`);\r\n  }\r\n  */ const { data: conflicts, error: conflictError } = await conflictQuery.limit(1);\n    if (conflictError) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        error: conflictError.message\n    }, {\n        status: 400\n    });\n    if (conflicts && conflicts.length > 0) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Ya hay un turno en ese horario\"\n        }, {\n            status: 409\n        });\n    }\n    const serviceSnapshot = resolvedService ? {\n        id: resolvedService.id,\n        name: resolvedService.name,\n        description: resolvedService.description,\n        duration_minutes: resolvedService.duration_minutes,\n        price_minor_units: resolvedService.price_minor_units,\n        currency: resolvedService.currency,\n        color: resolvedService.color\n    } : hasServiceId ? null : null; // typedExisting.service_snapshot as AppointmentRow[\"service_snapshot\"];\n    const manualServiceName = typeof service === \"string\" && service.trim().length > 0 ? service.trim() : null;\n    let serviceName = typedExisting.service_name ?? null;\n    if (hasServiceId) {\n        serviceName = resolvedService?.name ?? manualServiceName;\n    } else if (manualServiceName) {\n        serviceName = manualServiceName;\n    }\n    const updatePayload = {\n        location_id: locationId,\n        patient_id: patientId,\n        start_at: startAt.toISOString(),\n        end_at: endAt.toISOString(),\n        // service_id: nextServiceId, // Removed\n        // provider_id: nextProviderId, // Removed\n        service_name: serviceName,\n        // service_snapshot: serviceSnapshot, // Removed\n        internal_notes: notes ?? null\n    };\n    const { error: updateError, data: updated } = await db.from(\"agenda_appointments\").update(updatePayload).eq(\"id\", appointmentId).eq(\"tenant_id\", tenantId).select(\"id, start_at, end_at, status\").single();\n    if (updateError) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        error: updateError.message\n    }, {\n        status: 400\n    });\n    return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        ok: true,\n        appointment: updated\n    });\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvYXBwL2FwaS9hcHBvaW50bWVudHMvW2lkXS9yb3V0ZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUF3RDtBQUNHO0FBRUY7QUFDRDtBQUNEO0FBRU87QUFTdkQsZUFBZU8sTUFBTUMsT0FBb0IsRUFBRSxFQUFFQyxNQUFNLEVBQThCO0lBQ3RGLE1BQU1DLFdBQVdOLHFFQUFnQkE7SUFDakMsTUFBTSxFQUFFTyxNQUFNQyxJQUFJLEVBQUUsR0FBRyxNQUFNRixTQUFTRSxJQUFJLENBQUNDLFVBQVU7SUFDckQsTUFBTUMsY0FBYyxLQUFNQyxPQUFPLEVBQUVDLE1BQU1DLGNBQXFEQyxhQUN4Rk4sS0FBS0csT0FBTyxFQUFFQyxNQUFNRyxlQUFzREQsYUFDM0U7SUFDTCxNQUFNRSxhQUFhZCwyRUFBbUJBLENBQUNFLFFBQVFhLE9BQU87SUFDdEQsTUFBTUMsV0FBV1IsZUFBZU0sV0FBV0csVUFBVTtJQUVyRCxJQUFJLENBQUNYLEtBQUtHLE9BQU8sSUFBSSxDQUFDTyxVQUFVO1FBQzlCLE9BQU90QixxREFBWUEsQ0FBQ3dCLElBQUksQ0FBQztZQUFFQyxPQUFPO1FBQWUsR0FBRztZQUFFQyxRQUFRO1FBQUk7SUFDcEU7SUFFQSxJQUFJTixXQUFXRyxVQUFVLElBQUlULGVBQWVNLFdBQVdHLFVBQVUsS0FBS1QsZUFBZSxDQUFDTSxXQUFXTyxXQUFXLEVBQUU7UUFDNUcsT0FBTzNCLHFEQUFZQSxDQUFDd0IsSUFBSSxDQUFDO1lBQUVDLE9BQU87UUFBa0IsR0FBRztZQUFFQyxRQUFRO1FBQUk7SUFDdkU7SUFFQSw4RUFBOEU7SUFDOUUsTUFBTUUsS0FBS3ZCLGdFQUFhQSxJQUFJSztJQUU1QixNQUFNbUIsZ0JBQWdCcEIsT0FBT3FCLEVBQUU7SUFDL0IsSUFBSSxDQUFDRCxlQUFlO1FBQ2xCLE9BQU83QixxREFBWUEsQ0FBQ3dCLElBQUksQ0FBQztZQUFFQyxPQUFPO1FBQXlCLEdBQUc7WUFBRUMsUUFBUTtRQUFJO0lBQzlFO0lBRUEsTUFB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O0lBQUk7SUFFeEYsT0FBTzFCLHFEQUFZQSxDQUFDd0IsSUFBSSxDQUFDO1FBQUVnSSxJQUFJO1FBQU1DLGFBQWFGO0lBQVE7QUFDNUQiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hZ2VuZGFyLWFwcC8uL3NyYy9hcHAvYXBpL2FwcG9pbnRtZW50cy9baWRdL3JvdXRlLnRzPzQxMmQiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xyXG5pbXBvcnQgeyBhZGRNaW51dGVzLCBkaWZmZXJlbmNlSW5NaW51dGVzIH0gZnJvbSBcImRhdGUtZm5zXCI7XHJcbmltcG9ydCB7IFN1cGFiYXNlQ2xpZW50IH0gZnJvbSBcIkBzdXBhYmFzZS9zdXBhYmFzZS1qc1wiO1xyXG5pbXBvcnQgeyBpc1dpdGhpbkJ1c2luZXNzSG91cnMgfSBmcm9tIFwiQC9saWIvc2NoZWR1bGluZ1wiO1xyXG5pbXBvcnQgeyBnZXRSb3V0ZVN1cGFiYXNlIH0gZnJvbSBcIkAvbGliL3N1cGFiYXNlL3JvdXRlXCI7XHJcbmltcG9ydCB7IHNlcnZpY2VDbGllbnQgfSBmcm9tIFwiQC9saWIvc3VwYWJhc2Uvc2VydmljZVwiO1xyXG5pbXBvcnQgeyBEYXRhYmFzZSB9IGZyb20gXCJAL3R5cGVzL2RhdGFiYXNlXCI7XHJcbmltcG9ydCB7IGdldFRlbmFudEhlYWRlckluZm8gfSBmcm9tIFwiQC9zZXJ2ZXIvdGVuYW50LWhlYWRlcnNcIjtcclxuXHJcbnR5cGUgQXBwb2ludG1lbnRSb3cgPSBEYXRhYmFzZVtcInB1YmxpY1wiXVtcIlRhYmxlc1wiXVtcImFnZW5kYV9hcHBvaW50bWVudHNcIl1bXCJSb3dcIl07XHJcbnR5cGUgQXBwb2ludG1lbnRVcGRhdGUgPSBEYXRhYmFzZVtcInB1YmxpY1wiXVtcIlRhYmxlc1wiXVtcImFnZW5kYV9hcHBvaW50bWVudHNcIl1bXCJVcGRhdGVcIl07XHJcbnR5cGUgUGF0aWVudFJvdyA9IERhdGFiYXNlW1wicHVibGljXCJdW1wiVGFibGVzXCJdW1wiYWdlbmRhX3BhdGllbnRzXCJdW1wiUm93XCJdO1xyXG50eXBlIExvY2F0aW9uUm93ID0gRGF0YWJhc2VbXCJwdWJsaWNcIl1bXCJUYWJsZXNcIl1bXCJhZ2VuZGFfbG9jYXRpb25zXCJdW1wiUm93XCJdO1xyXG50eXBlIFNlcnZpY2VSb3cgPSBEYXRhYmFzZVtcInB1YmxpY1wiXVtcIlRhYmxlc1wiXVtcImFnZW5kYV9zZXJ2aWNlc1wiXVtcIlJvd1wiXTtcclxudHlwZSBQcm92aWRlclJvdyA9IERhdGFiYXNlW1wicHVibGljXCJdW1wiVGFibGVzXCJdW1wiYWdlbmRhX3Byb3ZpZGVyc1wiXVtcIlJvd1wiXTtcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQQVRDSChyZXF1ZXN0OiBOZXh0UmVxdWVzdCwgeyBwYXJhbXMgfTogeyBwYXJhbXM6IHsgaWQ6IHN0cmluZyB9IH0pIHtcclxuICBjb25zdCBzdXBhYmFzZSA9IGdldFJvdXRlU3VwYWJhc2UoKSBhcyB1bmtub3duIGFzIFN1cGFiYXNlQ2xpZW50PERhdGFiYXNlPjtcclxuICBjb25zdCB7IGRhdGE6IGF1dGggfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGguZ2V0U2Vzc2lvbigpO1xyXG4gIGNvbnN0IHRva2VuVGVuYW50ID0gKGF1dGguc2Vzc2lvbj8udXNlcj8uYXBwX21ldGFkYXRhIGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4gfCB1bmRlZmluZWQpPy50ZW5hbnRfaWRcclxuICAgID8/IChhdXRoLnNlc3Npb24/LnVzZXI/LnVzZXJfbWV0YWRhdGEgYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPiB8IHVuZGVmaW5lZCk/LnRlbmFudF9pZFxyXG4gICAgPz8gbnVsbDtcclxuICBjb25zdCBoZWFkZXJJbmZvID0gZ2V0VGVuYW50SGVhZGVySW5mbyhyZXF1ZXN0LmhlYWRlcnMgYXMgSGVhZGVycyk7XHJcbiAgY29uc3QgdGVuYW50SWQgPSB0b2tlblRlbmFudCA/PyBoZWFkZXJJbmZvLmludGVybmFsSWQ7XHJcblxyXG4gIGlmICghYXV0aC5zZXNzaW9uIHx8ICF0ZW5hbnRJZCkge1xyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6IFwiVW5hdXRob3JpemVkXCIgfSwgeyBzdGF0dXM6IDQwMSB9KTtcclxuICB9XHJcblxyXG4gIGlmIChoZWFkZXJJbmZvLmludGVybmFsSWQgJiYgdG9rZW5UZW5hbnQgJiYgaGVhZGVySW5mby5pbnRlcm5hbElkICE9PSB0b2tlblRlbmFudCAmJiAhaGVhZGVySW5mby5pc0RldkJ5cGFzcykge1xyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6IFwiVGVuYW50IG1pc21hdGNoXCIgfSwgeyBzdGF0dXM6IDQwMyB9KTtcclxuICB9XHJcblxyXG4gIC8vIFVzZSBzZXJ2aWNlQ2xpZW50IGZvciBEQiBvcGVyYXRpb25zIHRvIGJ5cGFzcyBSTFMgaW4gZGV2L21pc21hdGNoIHNjZW5hcmlvc1xyXG4gIGNvbnN0IGRiID0gc2VydmljZUNsaWVudCA/PyBzdXBhYmFzZTtcclxuXHJcbiAgY29uc3QgYXBwb2ludG1lbnRJZCA9IHBhcmFtcy5pZDtcclxuICBpZiAoIWFwcG9pbnRtZW50SWQpIHtcclxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBcIk1pc3NpbmcgYXBwb2ludG1lbnQgaWRcIiB9LCB7IHN0YXR1czogNDAwIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgYm9keSA9IGF3YWl0IHJlcXVlc3QuanNvbigpO1xyXG4gIGNvbnN0IHsgcGF0aWVudCwgcGhvbmUsIHN0YXJ0LCBkdXJhdGlvbiwgc2VydmljZSwgbm90ZXMsIGxvY2F0aW9uX2lkLCBzZXJ2aWNlSWQsIHByb3ZpZGVySWQgfSA9IGJvZHkgPz8ge307XHJcbiAgY29uc3QgcGF5bG9hZCA9IChib2R5ID8/IHt9KSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcclxuICBjb25zdCBoYXNTZXJ2aWNlSWQgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGF5bG9hZCwgXCJzZXJ2aWNlSWRcIik7XHJcbiAgY29uc3QgaGFzUHJvdmlkZXJJZCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXlsb2FkLCBcInByb3ZpZGVySWRcIik7XHJcblxyXG4gIGlmICghcGF0aWVudCB8fCAhcGhvbmUgfHwgIXN0YXJ0KSB7XHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCJGYWx0YW4gZGF0b3MgcmVxdWVyaWRvc1wiIH0sIHsgc3RhdHVzOiA0MDAgfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCB7IGRhdGE6IGV4aXN0aW5nQXBwdCwgZXJyb3I6IGZldGNoRXJyb3IgfSA9IGF3YWl0IGRiXHJcbiAgICAuZnJvbShcImFnZW5kYV9hcHBvaW50bWVudHNcIilcclxuICAgIC5zZWxlY3QoXHJcbiAgICAgIFwiaWQsIHRlbmFudF9pZCwgbG9jYXRpb25faWQsIHN0YXJ0X2F0LCBlbmRfYXQsIHN0YXR1cywgcGF0aWVudF9pZCwgc2VydmljZV9uYW1lXCIgLy8gUmVtb3ZlZCBwcm92aWRlcl9pZCwgc2VydmljZV9pZCwgc25hcHNob3RcclxuICAgIClcclxuICAgIC5lcShcImlkXCIsIGFwcG9pbnRtZW50SWQpXHJcbiAgICAuZXEoXCJ0ZW5hbnRfaWRcIiwgdGVuYW50SWQpXHJcbiAgICAuc2luZ2xlKCk7XHJcblxyXG4gIGNvbnN0IHR5cGVkRXhpc3RpbmcgPSBleGlzdGluZ0FwcHQgYXNcclxuICAgIHwgUGljazxcclxuICAgICAgICBBcHBvaW50bWVudFJvdyxcclxuICAgICAgICB8IFwiaWRcIlxyXG4gICAgICAgIHwgXCJ0ZW5hbnRfaWRcIlxyXG4gICAgICAgIHwgXCJsb2NhdGlvbl9pZFwiXHJcbiAgICAgICAgfCBcInN0YXJ0X2F0XCJcclxuICAgICAgICB8IFwiZW5kX2F0XCJcclxuICAgICAgICB8IFwic3RhdHVzXCJcclxuICAgICAgICB8IFwicGF0aWVudF9pZFwiXHJcbiAgICAgICAgfCBcInNlcnZpY2VfbmFtZVwiXHJcbiAgICAgICAgLy8gfCBcInNlcnZpY2VfaWRcIiAvLyBSZW1vdmVkXHJcbiAgICAgICAgLy8gfCBcInNlcnZpY2Vfc25hcHNob3RcIiAvLyBSZW1vdmVkXHJcbiAgICAgICAgLy8gfCBcInByb3ZpZGVyX2lkXCIgLy8gUmVtb3ZlZFxyXG4gICAgICA+XHJcbiAgICB8IG51bGw7XHJcblxyXG4gIGlmIChmZXRjaEVycm9yIHx8ICF0eXBlZEV4aXN0aW5nKSB7XHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCJUdXJubyBubyBlbmNvbnRyYWRvXCIgfSwgeyBzdGF0dXM6IDQwNCB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHN0YXJ0QXQgPSBuZXcgRGF0ZShzdGFydCk7XHJcbiAgaWYgKCFOdW1iZXIuaXNGaW5pdGUoc3RhcnRBdC5nZXRUaW1lKCkpKSB7XHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCJGZWNoYSBpbnbDoWxpZGFcIiB9LCB7IHN0YXR1czogNDAwIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZXhpc3RpbmdEdXJhdGlvbiA9IGRpZmZlcmVuY2VJbk1pbnV0ZXMobmV3IERhdGUodHlwZWRFeGlzdGluZy5lbmRfYXQpLCBuZXcgRGF0ZSh0eXBlZEV4aXN0aW5nLnN0YXJ0X2F0KSk7XHJcblxyXG4gIGNvbnN0IG5vcm1hbGl6ZWRQaG9uZSA9IHBob25lLnN0YXJ0c1dpdGgoXCIrXCIpID8gcGhvbmUgOiBgKyR7cGhvbmV9YDtcclxuXHJcbiAgLy8gUEFUQ0g6IERCIGNvbHVtbnMgbWlzc2luZ1xyXG4gIGNvbnN0IG5leHRTZXJ2aWNlSWQ6IHN0cmluZyB8IG51bGwgPSBoYXNTZXJ2aWNlSWQgPyAoc2VydmljZUlkID8/IG51bGwpIDogbnVsbDsgLy8gdHlwZWRFeGlzdGluZy5zZXJ2aWNlX2lkID8/IG51bGw7XHJcbiAgdHlwZSBTZXJ2aWNlTG9va3VwID0gUGljazxcclxuICAgIFNlcnZpY2VSb3csXHJcbiAgICBcImlkXCIgfCBcIm5hbWVcIiB8IFwiZGVzY3JpcHRpb25cIiB8IFwiZHVyYXRpb25fbWludXRlc1wiIHwgXCJwcmljZV9taW5vcl91bml0c1wiIHwgXCJjdXJyZW5jeVwiIHwgXCJjb2xvclwiIHwgXCJhY3RpdmVcIlxyXG4gID47XHJcbiAgbGV0IHJlc29sdmVkU2VydmljZTogU2VydmljZUxvb2t1cCB8IG51bGwgPSBudWxsO1xyXG4gIGlmIChuZXh0U2VydmljZUlkKSB7XHJcbiAgICBjb25zdCB7IGRhdGE6IHNlcnZpY2VSb3csIGVycm9yOiBzZXJ2aWNlRXJyb3IgfSA9IGF3YWl0IGRiXHJcbiAgICAgIC5mcm9tKFwiYWdlbmRhX3NlcnZpY2VzXCIpXHJcbiAgICAgIC5zZWxlY3QoXCJpZCwgdGVuYW50X2lkLCBuYW1lLCBkZXNjcmlwdGlvbiwgZHVyYXRpb25fbWludXRlcywgcHJpY2VfbWlub3JfdW5pdHMsIGN1cnJlbmN5LCBjb2xvciwgYWN0aXZlXCIpXHJcbiAgICAgIC5lcShcInRlbmFudF9pZFwiLCB0ZW5hbnRJZClcclxuICAgICAgLmVxKFwiaWRcIiwgbmV4dFNlcnZpY2VJZClcclxuICAgICAgLm1heWJlU2luZ2xlKCk7XHJcblxyXG4gICAgaWYgKHNlcnZpY2VFcnJvciB8fCAhc2VydmljZVJvdykge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCJTZXJ2aWNpbyBpbnbDoWxpZG9cIiB9LCB7IHN0YXR1czogNDAwIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghc2VydmljZVJvdy5hY3RpdmUpIHtcclxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6IFwiRWwgc2VydmljaW8gZXN0w6EgcGF1c2Fkb1wiIH0sIHsgc3RhdHVzOiA0MDAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVzb2x2ZWRTZXJ2aWNlID0gc2VydmljZVJvdyBhcyBTZXJ2aWNlTG9va3VwO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgbmV4dFByb3ZpZGVySWQ6IHN0cmluZyB8IG51bGwgPSBoYXNQcm92aWRlcklkID8gKHByb3ZpZGVySWQgPz8gbnVsbCkgOiBudWxsOyBcclxuICB0eXBlIFByb3ZpZGVyTG9va3VwID0gUGljazxQcm92aWRlclJvdywgXCJpZFwiIHwgXCJ0ZW5hbnRfaWRcIiB8IFwiZnVsbF9uYW1lXCIgfCBcImFjdGl2ZVwiIHwgXCJkZWZhdWx0X2xvY2F0aW9uX2lkXCIgfCBcIm1ldGFkYXRhXCI+O1xyXG4gIGxldCByZXNvbHZlZFByb3ZpZGVyOiBQcm92aWRlckxvb2t1cCB8IG51bGwgPSBudWxsO1xyXG4gIGlmIChuZXh0UHJvdmlkZXJJZCkge1xyXG4gICAgY29uc3QgeyBkYXRhOiBwcm92aWRlclJvdywgZXJyb3I6IHByb3ZpZGVyRXJyb3IgfSA9IGF3YWl0IGRiXHJcbiAgICAgIC5mcm9tKFwiYWdlbmRhX3Byb3ZpZGVyc1wiKVxyXG4gICAgICAuc2VsZWN0KFwiaWQsIHRlbmFudF9pZCwgZnVsbF9uYW1lLCBhY3RpdmUsIGRlZmF1bHRfbG9jYXRpb25faWQsIG1ldGFkYXRhXCIpXHJcbiAgICAgIC5lcShcInRlbmFudF9pZFwiLCB0ZW5hbnRJZClcclxuICAgICAgLmVxKFwiaWRcIiwgbmV4dFByb3ZpZGVySWQpXHJcbiAgICAgIC5tYXliZVNpbmdsZSgpO1xyXG5cclxuICAgIGlmIChwcm92aWRlckVycm9yIHx8ICFwcm92aWRlclJvdykge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCJQcm9mZXNpb25hbCBpbnbDoWxpZG9cIiB9LCB7IHN0YXR1czogNDAwIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghcHJvdmlkZXJSb3cuYWN0aXZlKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBcIkVsIHByb2Zlc2lvbmFsIGVzdMOhIHBhdXNhZG9cIiB9LCB7IHN0YXR1czogNDAwIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc29sdmVkUHJvdmlkZXIgPSBwcm92aWRlclJvdyBhcyBQcm92aWRlckxvb2t1cDtcclxuICB9XHJcblxyXG4gIGNvbnN0IGR1cmF0aW9uU291cmNlID0gTnVtYmVyKFxyXG4gICAgZHVyYXRpb24gPz8gcmVzb2x2ZWRTZXJ2aWNlPy5kdXJhdGlvbl9taW51dGVzID8/IGV4aXN0aW5nRHVyYXRpb24gPz8gMzBcclxuICApO1xyXG4gIGNvbnN0IGR1cmF0aW9uTWludXRlcyA9IE1hdGgubWF4KDUsIE51bWJlci5pc0Zpbml0ZShkdXJhdGlvblNvdXJjZSkgPyBkdXJhdGlvblNvdXJjZSA6IGV4aXN0aW5nRHVyYXRpb24gfHwgMzApO1xyXG4gIGNvbnN0IGVuZEF0ID0gYWRkTWludXRlcyhzdGFydEF0LCBkdXJhdGlvbk1pbnV0ZXMpO1xyXG5cclxuICBjb25zdCB7IGRhdGE6IGV4aXN0aW5nUGF0aWVudCB9ID0gYXdhaXQgZGJcclxuICAgIC5mcm9tKFwiYWdlbmRhX3BhdGllbnRzXCIpXHJcbiAgICAuc2VsZWN0KFwiaWRcIilcclxuICAgIC5lcShcInRlbmFudF9pZFwiLCB0ZW5hbnRJZClcclxuICAgIC5lcShcInBob25lX2UxNjRcIiwgbm9ybWFsaXplZFBob25lKVxyXG4gICAgLm1heWJlU2luZ2xlKCk7XHJcblxyXG4gIGNvbnN0IHR5cGVkUGF0aWVudCA9IGV4aXN0aW5nUGF0aWVudCBhcyBQaWNrPFBhdGllbnRSb3csIFwiaWRcIj4gfCBudWxsO1xyXG5cclxuICBsZXQgcGF0aWVudElkOiBzdHJpbmcgfCBudWxsID0gdHlwZWRQYXRpZW50Py5pZCA/PyB0eXBlZEV4aXN0aW5nLnBhdGllbnRfaWQgPz8gbnVsbDtcclxuICBpZiAoIXBhdGllbnRJZCkge1xyXG4gICAgY29uc3QgcGF0aWVudEluc2VydCA9IHtcclxuICAgICAgdGVuYW50X2lkOiB0ZW5hbnRJZCxcclxuICAgICAgZnVsbF9uYW1lOiBwYXRpZW50LFxyXG4gICAgICBwaG9uZV9lMTY0OiBub3JtYWxpemVkUGhvbmUsXHJcbiAgICAgIG9wdF9vdXQ6IGZhbHNlLFxyXG4gICAgfSBzYXRpc2ZpZXMgRGF0YWJhc2VbXCJwdWJsaWNcIl1bXCJUYWJsZXNcIl1bXCJhZ2VuZGFfcGF0aWVudHNcIl1bXCJJbnNlcnRcIl07XHJcblxyXG4gICAgY29uc3QgeyBkYXRhOiBpbnNlcnRlZCwgZXJyb3I6IHBhdGllbnRFcnJvciB9ID0gYXdhaXQgZGJcclxuICAgICAgLmZyb20oXCJhZ2VuZGFfcGF0aWVudHNcIilcclxuICAgICAgLmluc2VydChwYXRpZW50SW5zZXJ0KVxyXG4gICAgICAuc2VsZWN0KFwiaWRcIilcclxuICAgICAgLnNpbmdsZSgpO1xyXG4gICAgaWYgKHBhdGllbnRFcnJvcikgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6IHBhdGllbnRFcnJvci5tZXNzYWdlIH0sIHsgc3RhdHVzOiA0MDAgfSk7XHJcbiAgICBwYXRpZW50SWQgPSAoaW5zZXJ0ZWQgYXMgUGljazxQYXRpZW50Um93LCBcImlkXCI+KS5pZDtcclxuICB9IGVsc2Uge1xyXG4gICAgYXdhaXQgZGIuZnJvbShcImFnZW5kYV9wYXRpZW50c1wiKS51cGRhdGUoeyBmdWxsX25hbWU6IHBhdGllbnQgfSkuZXEoXCJpZFwiLCBwYXRpZW50SWQpLmVxKFwidGVuYW50X2lkXCIsIHRlbmFudElkKTtcclxuICB9XHJcblxyXG4gIGxldCBsb2NhdGlvbklkOiBzdHJpbmcgfCBudWxsID0gbG9jYXRpb25faWQgPz8gdHlwZWRFeGlzdGluZy5sb2NhdGlvbl9pZCA/PyByZXNvbHZlZFByb3ZpZGVyPy5kZWZhdWx0X2xvY2F0aW9uX2lkID8/IG51bGw7XHJcbiAgbGV0IGxvY2F0aW9uVGltZXpvbmUgPSBcIkFtZXJpY2EvQXJnZW50aW5hL0J1ZW5vc19BaXJlc1wiO1xyXG4gIGxldCBidWZmZXJNaW51dGVzID0gMDtcclxuICBsZXQgYnVzaW5lc3NIb3VyczogUmVjb3JkPHN0cmluZywgW3N0cmluZywgc3RyaW5nXVtdPiA9IHt9O1xyXG5cclxuICBpZiAobG9jYXRpb25JZCkge1xyXG4gICAgY29uc3QgeyBkYXRhOiBsb2NhdGlvblJvdyB9ID0gYXdhaXQgZGJcclxuICAgICAgLmZyb20oXCJhZ2VuZGFfbG9jYXRpb25zXCIpXHJcbiAgICAgIC5zZWxlY3QoXCJpZCwgdGltZXpvbmUsIGJ1ZmZlcl9taW51dGVzLCBidXNpbmVzc19ob3Vyc1wiKVxyXG4gICAgICAuZXEoXCJ0ZW5hbnRfaWRcIiwgdGVuYW50SWQpXHJcbiAgICAgIC5lcShcImlkXCIsIGxvY2F0aW9uSWQpXHJcbiAgICAgIC5tYXliZVNpbmdsZSgpO1xyXG4gICAgY29uc3QgdHlwZWRMb2NhdGlvbiA9IGxvY2F0aW9uUm93IGFzXHJcbiAgICAgIHwgUGljazxMb2NhdGlvblJvdywgXCJpZFwiIHwgXCJ0aW1lem9uZVwiIHwgXCJidWZmZXJfbWludXRlc1wiIHwgXCJidXNpbmVzc19ob3Vyc1wiPlxyXG4gICAgICB8IG51bGw7XHJcbiAgICBpZiAodHlwZWRMb2NhdGlvbikge1xyXG4gICAgICBsb2NhdGlvblRpbWV6b25lID0gdHlwZWRMb2NhdGlvbi50aW1lem9uZTtcclxuICAgICAgYnVmZmVyTWludXRlcyA9IHR5cGVkTG9jYXRpb24uYnVmZmVyX21pbnV0ZXMgPz8gMDtcclxuICAgICAgYnVzaW5lc3NIb3VycyA9ICh0eXBlZExvY2F0aW9uLmJ1c2luZXNzX2hvdXJzIGFzIFJlY29yZDxzdHJpbmcsIFtzdHJpbmcsIHN0cmluZ11bXT4pID8/IHt9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaWYgKCFsb2NhdGlvbklkKSB7XHJcbiAgICBjb25zdCB7IGRhdGE6IGZhbGxiYWNrIH0gPSBhd2FpdCBkYlxyXG4gICAgICAuZnJvbShcImFnZW5kYV9sb2NhdGlvbnNcIilcclxuICAgICAgLnNlbGVjdChcImlkLCB0aW1lem9uZSwgYnVmZmVyX21pbnV0ZXMsIGJ1c2luZXNzX2hvdXJzXCIpXHJcbiAgICAgIC5lcShcInRlbmFudF9pZFwiLCB0ZW5hbnRJZClcclxuICAgICAgLm9yZGVyKFwibmFtZVwiLCB7IGFzY2VuZGluZzogdHJ1ZSB9KVxyXG4gICAgICAubGltaXQoMSlcclxuICAgICAgLm1heWJlU2luZ2xlKCk7XHJcbiAgICBjb25zdCB0eXBlZEZhbGxiYWNrID0gZmFsbGJhY2sgYXNcclxuICAgICAgfCBQaWNrPExvY2F0aW9uUm93LCBcImlkXCIgfCBcInRpbWV6b25lXCIgfCBcImJ1ZmZlcl9taW51dGVzXCIgfCBcImJ1c2luZXNzX2hvdXJzXCI+XHJcbiAgICAgIHwgbnVsbDtcclxuICAgIGlmICh0eXBlZEZhbGxiYWNrKSB7XHJcbiAgICAgIGxvY2F0aW9uSWQgPSB0eXBlZEZhbGxiYWNrLmlkO1xyXG4gICAgICBsb2NhdGlvblRpbWV6b25lID0gdHlwZWRGYWxsYmFjay50aW1lem9uZTtcclxuICAgICAgYnVmZmVyTWludXRlcyA9IHR5cGVkRmFsbGJhY2suYnVmZmVyX21pbnV0ZXMgPz8gMDtcclxuICAgICAgYnVzaW5lc3NIb3VycyA9ICh0eXBlZEZhbGxiYWNrLmJ1c2luZXNzX2hvdXJzIGFzIFJlY29yZDxzdHJpbmcsIFtzdHJpbmcsIHN0cmluZ11bXT4pID8/IHt9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaWYgKCFsb2NhdGlvbklkKSB7XHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCJEZWJlIGNyZWFyIHVuYSB1YmljYWNpw7NuIHByaW1lcm9cIiB9LCB7IHN0YXR1czogNDAwIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gMS4gQ2hlY2sgUHJvdmlkZXIgT3ZlcnJpZGUgKHNpbWlsYXIgdG8gY3JlYXRlQXBwb2ludG1lbnQpXHJcbiAgaWYgKHJlc29sdmVkUHJvdmlkZXIpIHtcclxuICAgICBjb25zdCBwcm92U2NoZWR1bGUgPSAocmVzb2x2ZWRQcm92aWRlci5tZXRhZGF0YSBhcyBhbnkpPy5zY2hlZHVsZTtcclxuICAgICBpZiAocHJvdlNjaGVkdWxlICYmIE9iamVjdC5rZXlzKHByb3ZTY2hlZHVsZSkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGJ1c2luZXNzSG91cnMgPSBwcm92U2NoZWR1bGU7XHJcbiAgICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gMi4gRmFsbGJhY2sgZGVmYXVsdCBob3VycyBpZiBlbXB0eVxyXG4gIGlmIChPYmplY3Qua2V5cyhidXNpbmVzc0hvdXJzKS5sZW5ndGggPT09IDApIHtcclxuICAgIGJ1c2luZXNzSG91cnMgPSB7XHJcbiAgICAgIG1vbjogW1tcIjA5OjAwXCIsIFwiMTg6MDBcIl1dLFxyXG4gICAgICB0dWU6IFtbXCIwOTowMFwiLCBcIjE4OjAwXCJdXSxcclxuICAgICAgd2VkOiBbW1wiMDk6MDBcIiwgXCIxODowMFwiXV0sXHJcbiAgICAgIHRodTogW1tcIjA5OjAwXCIsIFwiMTg6MDBcIl1dLFxyXG4gICAgICBmcmk6IFtbXCIwOTowMFwiLCBcIjE4OjAwXCJdXSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBjb25zdCB2YWxpZEhvdXJzID0gaXNXaXRoaW5CdXNpbmVzc0hvdXJzKHtcclxuICAgIHN0YXJ0OiBzdGFydEF0LFxyXG4gICAgZW5kOiBlbmRBdCxcclxuICAgIGJ1c2luZXNzSG91cnMsXHJcbiAgICB0aW1lWm9uZTogbG9jYXRpb25UaW1lem9uZSxcclxuICB9KTtcclxuXHJcbiAgaWYgKCF2YWxpZEhvdXJzKSB7XHJcbiAgICBjb25zdCBkZWJ1Z0luZm8gPSBgU3RhcnQ6ICR7c3RhcnRBdC50b0lTT1N0cmluZygpfSwgTG9jVFo6ICR7bG9jYXRpb25UaW1lem9uZX0sIExvY2FsRGF5OiAke25ldyBJbnRsLkRhdGVUaW1lRm9ybWF0KFwiZW4tVVNcIiwgeyB0aW1lWm9uZTogbG9jYXRpb25UaW1lem9uZSwgd2Vla2RheTogXCJzaG9ydFwiLCBob3VyOiAnbnVtZXJpYycgfSkuZm9ybWF0KHN0YXJ0QXQpfWA7XHJcbiAgICBjb25zb2xlLmVycm9yKGBbQXBwb2ludG1lbnRQYXRjaEVycm9yXSBPdXRzaWRlIEJ1c2luZXNzIEhvdXJzLiAke2RlYnVnSW5mb31gKTtcclxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBgRnVlcmEgZGVsIGhvcmFyaW8gZGUgYXRlbmNpw7NuICgke2RlYnVnSW5mb30pYCB9LCB7IHN0YXR1czogNDAwIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgY29uZmxpY3RXaW5kb3dTdGFydCA9IGFkZE1pbnV0ZXMoc3RhcnRBdCwgLWJ1ZmZlck1pbnV0ZXMpO1xyXG4gIGNvbnN0IGNvbmZsaWN0V2luZG93RW5kID0gYWRkTWludXRlcyhlbmRBdCwgYnVmZmVyTWludXRlcyk7XHJcblxyXG4gIGxldCBjb25mbGljdFF1ZXJ5ID0gZGJcclxuICAgIC5mcm9tKFwiYWdlbmRhX2FwcG9pbnRtZW50c1wiKVxyXG4gICAgLnNlbGVjdChcImlkXCIpXHJcbiAgICAuZXEoXCJ0ZW5hbnRfaWRcIiwgdGVuYW50SWQpXHJcbiAgICAuZXEoXCJsb2NhdGlvbl9pZFwiLCBsb2NhdGlvbklkKVxyXG4gICAgLm5lcShcInN0YXR1c1wiLCBcImNhbmNlbGVkXCIpXHJcbiAgICAubmVxKFwiaWRcIiwgYXBwb2ludG1lbnRJZClcclxuICAgIC5sdChcInN0YXJ0X2F0XCIsIGNvbmZsaWN0V2luZG93RW5kLnRvSVNPU3RyaW5nKCkpXHJcbiAgICAuZ3QoXCJlbmRfYXRcIiwgY29uZmxpY3RXaW5kb3dTdGFydC50b0lTT1N0cmluZygpKTtcclxuXHJcbiAgLypcclxuICBpZiAobmV4dFByb3ZpZGVySWQpIHtcclxuICAgIGNvbmZsaWN0UXVlcnkgPSBjb25mbGljdFF1ZXJ5Lm9yKGBwcm92aWRlcl9pZC5lcS4ke25leHRQcm92aWRlcklkfSxwcm92aWRlcl9pZC5pcy5udWxsYCk7XHJcbiAgfVxyXG4gICovXHJcblxyXG4gIGNvbnN0IHsgZGF0YTogY29uZmxpY3RzLCBlcnJvcjogY29uZmxpY3RFcnJvciB9ID0gYXdhaXQgY29uZmxpY3RRdWVyeS5saW1pdCgxKTtcclxuXHJcbiAgaWYgKGNvbmZsaWN0RXJyb3IpIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBjb25mbGljdEVycm9yLm1lc3NhZ2UgfSwgeyBzdGF0dXM6IDQwMCB9KTtcclxuICBpZiAoY29uZmxpY3RzICYmIGNvbmZsaWN0cy5sZW5ndGggPiAwKSB7XHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCJZYSBoYXkgdW4gdHVybm8gZW4gZXNlIGhvcmFyaW9cIiB9LCB7IHN0YXR1czogNDA5IH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2VydmljZVNuYXBzaG90ID0gcmVzb2x2ZWRTZXJ2aWNlXHJcbiAgICA/IHtcclxuICAgICAgICBpZDogcmVzb2x2ZWRTZXJ2aWNlLmlkLFxyXG4gICAgICAgIG5hbWU6IHJlc29sdmVkU2VydmljZS5uYW1lLFxyXG4gICAgICAgIGRlc2NyaXB0aW9uOiByZXNvbHZlZFNlcnZpY2UuZGVzY3JpcHRpb24sXHJcbiAgICAgICAgZHVyYXRpb25fbWludXRlczogcmVzb2x2ZWRTZXJ2aWNlLmR1cmF0aW9uX21pbnV0ZXMsXHJcbiAgICAgICAgcHJpY2VfbWlub3JfdW5pdHM6IHJlc29sdmVkU2VydmljZS5wcmljZV9taW5vcl91bml0cyxcclxuICAgICAgICBjdXJyZW5jeTogcmVzb2x2ZWRTZXJ2aWNlLmN1cnJlbmN5LFxyXG4gICAgICAgIGNvbG9yOiByZXNvbHZlZFNlcnZpY2UuY29sb3IsXHJcbiAgICAgIH1cclxuICAgIDogaGFzU2VydmljZUlkXHJcbiAgICAgID8gbnVsbFxyXG4gICAgICA6IG51bGw7IC8vIHR5cGVkRXhpc3Rpbmcuc2VydmljZV9zbmFwc2hvdCBhcyBBcHBvaW50bWVudFJvd1tcInNlcnZpY2Vfc25hcHNob3RcIl07XHJcblxyXG4gIGNvbnN0IG1hbnVhbFNlcnZpY2VOYW1lID0gdHlwZW9mIHNlcnZpY2UgPT09IFwic3RyaW5nXCIgJiYgc2VydmljZS50cmltKCkubGVuZ3RoID4gMCA/IHNlcnZpY2UudHJpbSgpIDogbnVsbDtcclxuICBsZXQgc2VydmljZU5hbWUgPSB0eXBlZEV4aXN0aW5nLnNlcnZpY2VfbmFtZSA/PyBudWxsO1xyXG4gIGlmIChoYXNTZXJ2aWNlSWQpIHtcclxuICAgIHNlcnZpY2VOYW1lID0gcmVzb2x2ZWRTZXJ2aWNlPy5uYW1lID8/IG1hbnVhbFNlcnZpY2VOYW1lO1xyXG4gIH0gZWxzZSBpZiAobWFudWFsU2VydmljZU5hbWUpIHtcclxuICAgIHNlcnZpY2VOYW1lID0gbWFudWFsU2VydmljZU5hbWU7XHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGVQYXlsb2FkID0ge1xyXG4gICAgbG9jYXRpb25faWQ6IGxvY2F0aW9uSWQsXHJcbiAgICBwYXRpZW50X2lkOiBwYXRpZW50SWQsXHJcbiAgICBzdGFydF9hdDogc3RhcnRBdC50b0lTT1N0cmluZygpLFxyXG4gICAgZW5kX2F0OiBlbmRBdC50b0lTT1N0cmluZygpLFxyXG4gICAgLy8gc2VydmljZV9pZDogbmV4dFNlcnZpY2VJZCwgLy8gUmVtb3ZlZFxyXG4gICAgLy8gcHJvdmlkZXJfaWQ6IG5leHRQcm92aWRlcklkLCAvLyBSZW1vdmVkXHJcbiAgICBzZXJ2aWNlX25hbWU6IHNlcnZpY2VOYW1lLFxyXG4gICAgLy8gc2VydmljZV9zbmFwc2hvdDogc2VydmljZVNuYXBzaG90LCAvLyBSZW1vdmVkXHJcbiAgICBpbnRlcm5hbF9ub3Rlczogbm90ZXMgPz8gbnVsbCxcclxuICB9IHNhdGlzZmllcyBBcHBvaW50bWVudFVwZGF0ZTtcclxuXHJcbiAgY29uc3QgeyBlcnJvcjogdXBkYXRlRXJyb3IsIGRhdGE6IHVwZGF0ZWQgfSA9IGF3YWl0IGRiXHJcbiAgICAuZnJvbShcImFnZW5kYV9hcHBvaW50bWVudHNcIilcclxuICAgIC51cGRhdGUodXBkYXRlUGF5bG9hZClcclxuICAgIC5lcShcImlkXCIsIGFwcG9pbnRtZW50SWQpXHJcbiAgICAuZXEoXCJ0ZW5hbnRfaWRcIiwgdGVuYW50SWQpXHJcbiAgICAuc2VsZWN0KFwiaWQsIHN0YXJ0X2F0LCBlbmRfYXQsIHN0YXR1c1wiKVxyXG4gICAgLnNpbmdsZSgpO1xyXG5cclxuICBpZiAodXBkYXRlRXJyb3IpIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiB1cGRhdGVFcnJvci5tZXNzYWdlIH0sIHsgc3RhdHVzOiA0MDAgfSk7XHJcblxyXG4gIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IG9rOiB0cnVlLCBhcHBvaW50bWVudDogdXBkYXRlZCB9KTtcclxufVxyXG4iXSwibmFtZXMiOlsiTmV4dFJlc3BvbnNlIiwiYWRkTWludXRlcyIsImRpZmZlcmVuY2VJbk1pbnV0ZXMiLCJpc1dpdGhpbkJ1c2luZXNzSG91cnMiLCJnZXRSb3V0ZVN1cGFiYXNlIiwic2VydmljZUNsaWVudCIsImdldFRlbmFudEhlYWRlckluZm8iLCJQQVRDSCIsInJlcXVlc3QiLCJwYXJhbXMiLCJzdXBhYmFzZSIsImRhdGEiLCJhdXRoIiwiZ2V0U2Vzc2lvbiIsInRva2VuVGVuYW50Iiwic2Vzc2lvbiIsInVzZXIiLCJhcHBfbWV0YWRhdGEiLCJ0ZW5hbnRfaWQiLCJ1c2VyX21ldGFkYXRhIiwiaGVhZGVySW5mbyIsImhlYWRlcnMiLCJ0ZW5hbnRJZCIsImludGVybmFsSWQiLCJqc29uIiwiZXJyb3IiLCJzdGF0dXMiLCJpc0RldkJ5cGFzcyIsImRiIiwiYXBwb2ludG1lbnRJZCIsImlkIiwiYm9keSIsInBhdGllbnQiLCJwaG9uZSIsInN0YXJ0IiwiZHVyYXRpb24iLCJzZXJ2aWNlIiwibm90ZXMiLCJsb2NhdGlvbl9pZCIsInNlcnZpY2VJZCIsInByb3ZpZGVySWQiLCJwYXlsb2FkIiwiaGFzU2VydmljZUlkIiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiaGFzUHJvdmlkZXJJZCIsImV4aXN0aW5nQXBwdCIsImZldGNoRXJyb3IiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJzaW5nbGUiLCJ0eXBlZEV4aXN0aW5nIiwic3RhcnRBdCIsIkRhdGUiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsImdldFRpbWUiLCJleGlzdGluZ0R1cmF0aW9uIiwiZW5kX2F0Iiwic3RhcnRfYXQiLCJub3JtYWxpemVkUGhvbmUiLCJzdGFydHNXaXRoIiwibmV4dFNlcnZpY2VJZCIsInJlc29sdmVkU2VydmljZSIsInNlcnZpY2VSb3ciLCJzZXJ2aWNlRXJyb3IiLCJtYXliZVNpbmdsZSIsImFjdGl2ZSIsIm5leHRQcm92aWRlcklkIiwicmVzb2x2ZWRQcm92aWRlciIsInByb3ZpZGVyUm93IiwicHJvdmlkZXJFcnJvciIsImR1cmF0aW9uU291cmNlIiwiZHVyYXRpb25fbWludXRlcyIsImR1cmF0aW9uTWludXRlcyIsIk1hdGgiLCJtYXgiLCJlbmRBdCIsImV4aXN0aW5nUGF0aWVudCIsInR5cGVkUGF0aWVudCIsInBhdGllbnRJZCIsInBhdGllbnRfaWQiLCJwYXRpZW50SW5zZXJ0IiwiZnVsbF9uYW1lIiwicGhvbmVfZTE2NCIsIm9wdF9vdXQiLCJpbnNlcnRlZCIsInBhdGllbnRFcnJvciIsImluc2VydCIsIm1lc3NhZ2UiLCJ1cGRhdGUiLCJsb2NhdGlvbklkIiwiZGVmYXVsdF9sb2NhdGlvbl9pZCIsImxvY2F0aW9uVGltZXpvbmUiLCJidWZmZXJNaW51dGVzIiwiYnVzaW5lc3NIb3VycyIsImxvY2F0aW9uUm93IiwidHlwZWRMb2NhdGlvbiIsInRpbWV6b25lIiwiYnVmZmVyX21pbnV0ZXMiLCJidXNpbmVzc19ob3VycyIsImZhbGxiYWNrIiwib3JkZXIiLCJhc2NlbmRpbmciLCJsaW1pdCIsInR5cGVkRmFsbGJhY2siLCJwcm92U2NoZWR1bGUiLCJtZXRhZGF0YSIsInNjaGVkdWxlIiwia2V5cyIsImxlbmd0aCIsIm1vbiIsInR1ZSIsIndlZCIsInRodSIsImZyaSIsInZhbGlkSG91cnMiLCJlbmQiLCJ0aW1lWm9uZSIsImRlYnVnSW5mbyIsInRvSVNPU3RyaW5nIiwiSW50bCIsIkRhdGVUaW1lRm9ybWF0Iiwid2Vla2RheSIsImhvdXIiLCJmb3JtYXQiLCJjb25zb2xlIiwiY29uZmxpY3RXaW5kb3dTdGFydCIsImNvbmZsaWN0V2luZG93RW5kIiwiY29uZmxpY3RRdWVyeSIsIm5lcSIsImx0IiwiZ3QiLCJjb25mbGljdHMiLCJjb25mbGljdEVycm9yIiwic2VydmljZVNuYXBzaG90IiwibmFtZSIsImRlc2NyaXB0aW9uIiwicHJpY2VfbWlub3JfdW5pdHMiLCJjdXJyZW5jeSIsImNvbG9yIiwibWFudWFsU2VydmljZU5hbWUiLCJ0cmltIiwic2VydmljZU5hbWUiLCJzZXJ2aWNlX25hbWUiLCJ1cGRhdGVQYXlsb2FkIiwiaW50ZXJuYWxfbm90ZXMiLCJ1cGRhdGVFcnJvciIsInVwZGF0ZWQiLCJvayIsImFwcG9pbnRtZW50Il0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./src/app/api/appointments/[id]/route.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/constants.ts":
/*!******************************!*\
  !*** ./src/lib/constants.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   APPOINTMENT_STATUS: () => (/* binding */ APPOINTMENT_STATUS),\n/* harmony export */   APP_TIMEZONE: () => (/* binding */ APP_TIMEZONE),\n/* harmony export */   CRON_SECRET_HEADER: () => (/* binding */ CRON_SECRET_HEADER),\n/* harmony export */   DEFAULT_SLOT_DURATION_MIN: () => (/* binding */ DEFAULT_SLOT_DURATION_MIN),\n/* harmony export */   SLOT_LOOKAHEAD_DAYS: () => (/* binding */ SLOT_LOOKAHEAD_DAYS),\n/* harmony export */   WAITLIST_LOOKAHEAD_HOURS: () => (/* binding */ WAITLIST_LOOKAHEAD_HOURS)\n/* harmony export */ });\nconst APP_TIMEZONE = \"America/Argentina/Buenos_Aires\";\nconst DEFAULT_SLOT_DURATION_MIN = 30;\nconst SLOT_LOOKAHEAD_DAYS = 7;\nconst WAITLIST_LOOKAHEAD_HOURS = 48;\nconst APPOINTMENT_STATUS = [\n    \"pending\",\n    \"confirmed\",\n    \"reschedule_requested\",\n    \"canceled\",\n    \"completed\",\n    \"no_show\"\n];\nconst CRON_SECRET_HEADER = \"x-cron-secret\";\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL2NvbnN0YW50cy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBTyxNQUFNQSxlQUFlLGlDQUEwQztBQUMvRCxNQUFNQyw0QkFBNEIsR0FBRztBQUNyQyxNQUFNQyxzQkFBc0IsRUFBRTtBQUM5QixNQUFNQywyQkFBMkIsR0FBRztBQUVwQyxNQUFNQyxxQkFBcUI7SUFDaEM7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0NBQ0QsQ0FBVTtBQUlKLE1BQU1DLHFCQUFxQixnQkFBZ0IiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hZ2VuZGFyLWFwcC8uL3NyYy9saWIvY29uc3RhbnRzLnRzP2ZiZjkiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNvbnN0IEFQUF9USU1FWk9ORSA9IFwiQW1lcmljYS9BcmdlbnRpbmEvQnVlbm9zX0FpcmVzXCIgYXMgY29uc3Q7XHJcbmV4cG9ydCBjb25zdCBERUZBVUxUX1NMT1RfRFVSQVRJT05fTUlOID0gMzA7XHJcbmV4cG9ydCBjb25zdCBTTE9UX0xPT0tBSEVBRF9EQVlTID0gNztcclxuZXhwb3J0IGNvbnN0IFdBSVRMSVNUX0xPT0tBSEVBRF9IT1VSUyA9IDQ4O1xyXG5cclxuZXhwb3J0IGNvbnN0IEFQUE9JTlRNRU5UX1NUQVRVUyA9IFtcclxuICBcInBlbmRpbmdcIixcclxuICBcImNvbmZpcm1lZFwiLFxyXG4gIFwicmVzY2hlZHVsZV9yZXF1ZXN0ZWRcIixcclxuICBcImNhbmNlbGVkXCIsXHJcbiAgXCJjb21wbGV0ZWRcIixcclxuICBcIm5vX3Nob3dcIixcclxuXSBhcyBjb25zdDtcclxuXHJcbmV4cG9ydCB0eXBlIEFwcG9pbnRtZW50U3RhdHVzID0gKHR5cGVvZiBBUFBPSU5UTUVOVF9TVEFUVVMpW251bWJlcl07XHJcblxyXG5leHBvcnQgY29uc3QgQ1JPTl9TRUNSRVRfSEVBREVSID0gXCJ4LWNyb24tc2VjcmV0XCI7XHJcbiJdLCJuYW1lcyI6WyJBUFBfVElNRVpPTkUiLCJERUZBVUxUX1NMT1RfRFVSQVRJT05fTUlOIiwiU0xPVF9MT09LQUhFQURfREFZUyIsIldBSVRMSVNUX0xPT0tBSEVBRF9IT1VSUyIsIkFQUE9JTlRNRU5UX1NUQVRVUyIsIkNST05fU0VDUkVUX0hFQURFUiJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/constants.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/scheduling.ts":
/*!*******************************!*\
  !*** ./src/lib/scheduling.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   calculateAvailability: () => (/* binding */ calculateAvailability),\n/* harmony export */   isWithinBusinessHours: () => (/* binding */ isWithinBusinessHours)\n/* harmony export */ });\n/* harmony import */ var _barrel_optimize_names_addMinutes_isBefore_date_fns__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! __barrel_optimize__?names=addMinutes,isBefore!=!date-fns */ \"(rsc)/./node_modules/date-fns/isBefore.mjs\");\n/* harmony import */ var _barrel_optimize_names_addMinutes_isBefore_date_fns__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! __barrel_optimize__?names=addMinutes,isBefore!=!date-fns */ \"(rsc)/./node_modules/date-fns/addMinutes.mjs\");\n/* harmony import */ var _lib_constants__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @/lib/constants */ \"(rsc)/./src/lib/constants.ts\");\n\n\nfunction isWithinBusinessHours(options) {\n    const { start, end, businessHours, timeZone } = options;\n    const fmt = new Intl.DateTimeFormat(\"en-US\", {\n        timeZone,\n        weekday: \"short\",\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n        hour12: false\n    });\n    const partsStart = Object.fromEntries(fmt.formatToParts(start).map((p)=>[\n            p.type,\n            p.value\n        ]));\n    const partsEnd = Object.fromEntries(fmt.formatToParts(end).map((p)=>[\n            p.type,\n            p.value\n        ]));\n    const dayKey = (partsStart.weekday ?? \"\").slice(0, 3).toLowerCase(); // mon/tue...\n    if (dayKey !== (partsEnd.weekday ?? \"\").slice(0, 3).toLowerCase()) return false;\n    const intervals = businessHours?.[dayKey];\n    if (!intervals || intervals.length === 0) return false;\n    const toMinutes = (h, m)=>Number(h) * 60 + Number(m);\n    const startMinutes = toMinutes(partsStart.hour ?? \"0\", partsStart.minute ?? \"0\");\n    const endMinutes = toMinutes(partsEnd.hour ?? \"0\", partsEnd.minute ?? \"0\");\n    return intervals.some(([from, to])=>{\n        const [fh, fm] = from.split(\":\");\n        const [th, tm] = to.split(\":\");\n        const fromM = toMinutes(fh, fm);\n        const toM = toMinutes(th, tm);\n        return startMinutes >= fromM && endMinutes <= toM;\n    });\n}\nfunction calculateAvailability({ start, end, appointments, durationMinutes = _lib_constants__WEBPACK_IMPORTED_MODULE_0__.DEFAULT_SLOT_DURATION_MIN, bufferMinutes = 0 }) {\n    const slots = [];\n    let cursor = new Date(start);\n    while((0,_barrel_optimize_names_addMinutes_isBefore_date_fns__WEBPACK_IMPORTED_MODULE_1__.isBefore)((0,_barrel_optimize_names_addMinutes_isBefore_date_fns__WEBPACK_IMPORTED_MODULE_2__.addMinutes)(cursor, durationMinutes), end)){\n        const candidateEnd = (0,_barrel_optimize_names_addMinutes_isBefore_date_fns__WEBPACK_IMPORTED_MODULE_2__.addMinutes)(cursor, durationMinutes);\n        const overlaps = appointments.some((appt)=>{\n            const apptStart = new Date(appt.start_at);\n            const apptEnd = new Date(appt.end_at);\n            return cursor < apptEnd && candidateEnd > apptStart;\n        });\n        if (!overlaps) {\n            slots.push({\n                start: new Date(cursor),\n                end: candidateEnd\n            });\n        }\n        cursor = (0,_barrel_optimize_names_addMinutes_isBefore_date_fns__WEBPACK_IMPORTED_MODULE_2__.addMinutes)(cursor, durationMinutes + bufferMinutes);\n    }\n    return slots;\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LWFwcC8uL3NyYy9saWIvc2NoZWR1bGluZy50cz8zZWYzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFkZE1pbnV0ZXMsIGlzQmVmb3JlIH0gZnJvbSBcImRhdGUtZm5zXCI7XHJcbmltcG9ydCB7IERFRkFVTFRfU0xPVF9EVVJBVElPTl9NSU4gfSBmcm9tIFwiQC9saWIvY29uc3RhbnRzXCI7XHJcbmltcG9ydCB7IERhdGFiYXNlIH0gZnJvbSBcIkAvdHlwZXMvZGF0YWJhc2VcIjtcclxuXHJcbmV4cG9ydCB0eXBlIEFwcG9pbnRtZW50Um93ID0gRGF0YWJhc2VbXCJwdWJsaWNcIl1bXCJUYWJsZXNcIl1bXCJhZ2VuZGFfYXBwb2ludG1lbnRzXCJdW1wiUm93XCJdO1xyXG5cclxudHlwZSBCdXNpbmVzc0hvdXJzID0gUmVjb3JkPHN0cmluZywgW3N0cmluZywgc3RyaW5nXVtdPjtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1dpdGhpbkJ1c2luZXNzSG91cnMob3B0aW9uczoge1xyXG4gIHN0YXJ0OiBEYXRlO1xyXG4gIGVuZDogRGF0ZTtcclxuICBidXNpbmVzc0hvdXJzOiBCdXNpbmVzc0hvdXJzO1xyXG4gIHRpbWVab25lOiBzdHJpbmc7XHJcbn0pIHtcclxuICBjb25zdCB7IHN0YXJ0LCBlbmQsIGJ1c2luZXNzSG91cnMsIHRpbWVab25lIH0gPSBvcHRpb25zO1xyXG4gIGNvbnN0IGZtdCA9IG5ldyBJbnRsLkRhdGVUaW1lRm9ybWF0KFwiZW4tVVNcIiwge1xyXG4gICAgdGltZVpvbmUsXHJcbiAgICB3ZWVrZGF5OiBcInNob3J0XCIsXHJcbiAgICBob3VyOiBcIjItZGlnaXRcIixcclxuICAgIG1pbnV0ZTogXCIyLWRpZ2l0XCIsXHJcbiAgICBob3VyMTI6IGZhbHNlLFxyXG4gIH0pO1xyXG5cclxuICBjb25zdCBwYXJ0c1N0YXJ0ID0gT2JqZWN0LmZyb21FbnRyaWVzKGZtdC5mb3JtYXRUb1BhcnRzKHN0YXJ0KS5tYXAoKHApID0+IFtwLnR5cGUsIHAudmFsdWVdKSk7XHJcbiAgY29uc3QgcGFydHNFbmQgPSBPYmplY3QuZnJvbUVudHJpZXMoZm10LmZvcm1hdFRvUGFydHMoZW5kKS5tYXAoKHApID0+IFtwLnR5cGUsIHAudmFsdWVdKSk7XHJcblxyXG4gIGNvbnN0IGRheUtleSA9IChwYXJ0c1N0YXJ0LndlZWtkYXkgPz8gXCJcIikuc2xpY2UoMCwgMykudG9Mb3dlckNhc2UoKTsgLy8gbW9uL3R1ZS4uLlxyXG4gIGlmIChkYXlLZXkgIT09IChwYXJ0c0VuZC53ZWVrZGF5ID8/IFwiXCIpLnNsaWNlKDAsIDMpLnRvTG93ZXJDYXNlKCkpIHJldHVybiBmYWxzZTtcclxuXHJcbiAgY29uc3QgaW50ZXJ2YWxzID0gYnVzaW5lc3NIb3Vycz8uW2RheUtleV07XHJcbiAgaWYgKCFpbnRlcnZhbHMgfHwgaW50ZXJ2YWxzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlO1xyXG5cclxuICBjb25zdCB0b01pbnV0ZXMgPSAoaDogc3RyaW5nLCBtOiBzdHJpbmcpID0+IE51bWJlcihoKSAqIDYwICsgTnVtYmVyKG0pO1xyXG4gIGNvbnN0IHN0YXJ0TWludXRlcyA9IHRvTWludXRlcyhwYXJ0c1N0YXJ0LmhvdXIgPz8gXCIwXCIsIHBhcnRzU3RhcnQubWludXRlID8/IFwiMFwiKTtcclxuICBjb25zdCBlbmRNaW51dGVzID0gdG9NaW51dGVzKHBhcnRzRW5kLmhvdXIgPz8gXCIwXCIsIHBhcnRzRW5kLm1pbnV0ZSA/PyBcIjBcIik7XHJcblxyXG4gIHJldHVybiBpbnRlcnZhbHMuc29tZSgoW2Zyb20sIHRvXSkgPT4ge1xyXG4gICAgY29uc3QgW2ZoLCBmbV0gPSBmcm9tLnNwbGl0KFwiOlwiKTtcclxuICAgIGNvbnN0IFt0aCwgdG1dID0gdG8uc3BsaXQoXCI6XCIpO1xyXG4gICAgY29uc3QgZnJvbU0gPSB0b01pbnV0ZXMoZmgsIGZtKTtcclxuICAgIGNvbnN0IHRvTSA9IHRvTWludXRlcyh0aCwgdG0pO1xyXG4gICAgcmV0dXJuIHN0YXJ0TWludXRlcyA+PSBmcm9tTSAmJiBlbmRNaW51dGVzIDw9IHRvTTtcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZUF2YWlsYWJpbGl0eSh7XHJcbiAgc3RhcnQsXHJcbiAgZW5kLFxyXG4gIGFwcG9pbnRtZW50cyxcclxuICBkdXJhdGlvbk1pbnV0ZXMgPSBERUZBVUxUX1NMT1RfRFVSQVRJT05fTUlOLFxyXG4gIGJ1ZmZlck1pbnV0ZXMgPSAwLFxyXG59OiB7XHJcbiAgc3RhcnQ6IERhdGU7XHJcbiAgZW5kOiBEYXRlO1xyXG4gIGFwcG9pbnRtZW50czogQXBwb2ludG1lbnRSb3dbXTtcclxuICBkdXJhdGlvbk1pbnV0ZXM/OiBudW1iZXI7XHJcbiAgYnVmZmVyTWludXRlcz86IG51bWJlcjtcclxufSkge1xyXG4gIGNvbnN0IHNsb3RzOiB7IHN0YXJ0OiBEYXRlOyBlbmQ6IERhdGUgfVtdID0gW107XHJcbiAgbGV0IGN1cnNvciA9IG5ldyBEYXRlKHN0YXJ0KTtcclxuXHJcbiAgd2hpbGUgKGlzQmVmb3JlKGFkZE1pbnV0ZXMoY3Vyc29yLCBkdXJhdGlvbk1pbnV0ZXMpLCBlbmQpKSB7XHJcbiAgICBjb25zdCBjYW5kaWRhdGVFbmQgPSBhZGRNaW51dGVzKGN1cnNvciwgZHVyYXRpb25NaW51dGVzKTtcclxuICAgIGNvbnN0IG92ZXJsYXBzID0gYXBwb2ludG1lbnRzLnNvbWUoKGFwcHQpID0+IHtcclxuICAgICAgY29uc3QgYXBwdFN0YXJ0ID0gbmV3IERhdGUoYXBwdC5zdGFydF9hdCk7XHJcbiAgICAgIGNvbnN0IGFwcHRFbmQgPSBuZXcgRGF0ZShhcHB0LmVuZF9hdCk7XHJcbiAgICAgIHJldHVybiBjdXJzb3IgPCBhcHB0RW5kICYmIGNhbmRpZGF0ZUVuZCA+IGFwcHRTdGFydDtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghb3ZlcmxhcHMpIHtcclxuICAgICAgc2xvdHMucHVzaCh7IHN0YXJ0OiBuZXcgRGF0ZShjdXJzb3IpLCBlbmQ6IGNhbmRpZGF0ZUVuZCB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjdXJzb3IgPSBhZGRNaW51dGVzKGN1cnNvciwgZHVyYXRpb25NaW51dGVzICsgYnVmZmVyTWludXRlcyk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gc2xvdHM7XHJcbn1cclxuIl0sIm5hbWVzIjpbImFkZE1pbnV0ZXMiLCJpc0JlZm9yZSIsIkRFRkFVTFRfU0xPVF9EVVJBVElPTl9NSU4iLCJpc1dpdGhpbkJ1c2luZXNzSG91cnMiLCJvcHRpb25zIiwic3RhcnQiLCJlbmQiLCJidXNpbmVzc0hvdXJzIiwidGltZVpvbmUiLCJmbXQiLCJJbnRsIiwiRGF0ZVRpbWVGb3JtYXQiLCJ3ZWVrZGF5IiwiaG91ciIsIm1pbnV0ZSIsImhvdXIxMiIsInBhcnRzU3RhcnQiLCJPYmplY3QiLCJmcm9tRW50cmllcyIsImZvcm1hdFRvUGFydHMiLCJtYXAiLCJwIiwidHlwZSIsInZhbHVlIiwicGFydHNFbmQiLCJkYXlLZXkiLCJzbGljZSIsInRvTG93ZXJDYXNlIiwiaW50ZXJ2YWxzIiwibGVuZ3RoIiwidG9NaW51dGVzIiwiaCIsIm0iLCJOdW1iZXIiLCJzdGFydE1pbnV0ZXMiLCJlbmRNaW51dGVzIiwic29tZSIsImZyb20iLCJ0byIsImZoIiwiZm0iLCJzcGxpdCIsInRoIiwidG0iLCJmcm9tTSIsInRvTSIsImNhbGN1bGF0ZUF2YWlsYWJpbGl0eSIsImFwcG9pbnRtZW50cyIsImR1cmF0aW9uTWludXRlcyIsImJ1ZmZlck1pbnV0ZXMiLCJzbG90cyIsImN1cnNvciIsIkRhdGUiLCJjYW5kaWRhdGVFbmQiLCJvdmVybGFwcyIsImFwcHQiLCJhcHB0U3RhcnQiLCJzdGFydF9hdCIsImFwcHRFbmQiLCJlbmRfYXQiLCJwdXNoIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/scheduling.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/supabase/route.ts":
/*!***********************************!*\
  !*** ./src/lib/supabase/route.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   getRouteSupabase: () => (/* binding */ getRouteSupabase)\n/* harmony export */ });\n/* harmony import */ var next_headers__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/headers */ \"(rsc)/./node_modules/next/dist/api/headers.js\");\n/* harmony import */ var _supabase_auth_helpers_nextjs__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @supabase/auth-helpers-nextjs */ \"(rsc)/./node_modules/@supabase/auth-helpers-nextjs/dist/index.js\");\n/* harmony import */ var _supabase_auth_helpers_nextjs__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(_supabase_auth_helpers_nextjs__WEBPACK_IMPORTED_MODULE_1__);\n\n\nfunction getRouteSupabase() {\n    return (0,_supabase_auth_helpers_nextjs__WEBPACK_IMPORTED_MODULE_1__.createRouteHandlerClient)({\n        cookies: next_headers__WEBPACK_IMPORTED_MODULE_0__.cookies\n    });\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL3N1cGFiYXNlL3JvdXRlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBdUM7QUFDa0M7QUFHbEUsU0FBU0U7SUFDZCxPQUFPRCx1RkFBd0JBLENBQVc7UUFBRUQsT0FBT0EsbURBQUFBO0lBQUM7QUFDdEQiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hZ2VuZGFyLWFwcC8uL3NyYy9saWIvc3VwYWJhc2Uvcm91dGUudHM/M2NlNiJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb29raWVzIH0gZnJvbSBcIm5leHQvaGVhZGVyc1wiO1xyXG5pbXBvcnQgeyBjcmVhdGVSb3V0ZUhhbmRsZXJDbGllbnQgfSBmcm9tIFwiQHN1cGFiYXNlL2F1dGgtaGVscGVycy1uZXh0anNcIjtcclxuaW1wb3J0IHsgRGF0YWJhc2UgfSBmcm9tIFwiQC90eXBlcy9kYXRhYmFzZVwiO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFJvdXRlU3VwYWJhc2UoKSB7XHJcbiAgcmV0dXJuIGNyZWF0ZVJvdXRlSGFuZGxlckNsaWVudDxEYXRhYmFzZT4oeyBjb29raWVzIH0pO1xyXG59XHJcbiJdLCJuYW1lcyI6WyJjb29raWVzIiwiY3JlYXRlUm91dGVIYW5kbGVyQ2xpZW50IiwiZ2V0Um91dGVTdXBhYmFzZSJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/supabase/route.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/supabase/service.ts":
/*!*************************************!*\
  !*** ./src/lib/supabase/service.ts ***!
  \*************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   serviceClient: () => (/* binding */ serviceClient)\n/* harmony export */ });\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/index.mjs\");\n\nconst url = \"https://oaxielrsiogvnxradtsw.supabase.co\";\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\nif (!url || !serviceKey) {\n    console.warn(\"Supabase service client is not fully configured.\");\n}\nconst serviceClient = url && serviceKey ? (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__.createClient)(url, serviceKey, {\n    auth: {\n        persistSession: false\n    }\n}) : null;\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL3N1cGFiYXNlL3NlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBcUQ7QUFHckQsTUFBTUMsTUFBTUMsMENBQW9DO0FBQ2hELE1BQU1HLGFBQWFILFFBQVFDLEdBQUcsQ0FBQ0cseUJBQXlCO0FBRXhELElBQUksQ0FBQ0wsT0FBTyxDQUFDSSxZQUFZO0lBQ3ZCRSxRQUFRQyxJQUFJLENBQUM7QUFDZjtBQUVPLE1BQU1DLGdCQUFnQlIsT0FBT0ksYUFDaENMLG1FQUFZQSxDQUFXQyxLQUFLSSxZQUFZO0lBQ3RDSyxNQUFNO1FBQUVDLGdCQUFnQjtJQUFNO0FBQ2hDLEtBQ0EsS0FBSyIsInNvdXJjZXMiOlsid2VicGFjazovL2FnZW5kYXItYXBwLy4vc3JjL2xpYi9zdXBhYmFzZS9zZXJ2aWNlLnRzP2MyMGYiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSBcIkBzdXBhYmFzZS9zdXBhYmFzZS1qc1wiO1xyXG5pbXBvcnQgeyBEYXRhYmFzZSB9IGZyb20gXCJAL3R5cGVzL2RhdGFiYXNlXCI7XHJcblxyXG5jb25zdCB1cmwgPSBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkw7XHJcbmNvbnN0IHNlcnZpY2VLZXkgPSBwcm9jZXNzLmVudi5TVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZO1xyXG5cclxuaWYgKCF1cmwgfHwgIXNlcnZpY2VLZXkpIHtcclxuICBjb25zb2xlLndhcm4oXCJTdXBhYmFzZSBzZXJ2aWNlIGNsaWVudCBpcyBub3QgZnVsbHkgY29uZmlndXJlZC5cIik7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBzZXJ2aWNlQ2xpZW50ID0gdXJsICYmIHNlcnZpY2VLZXlcclxuICA/IGNyZWF0ZUNsaWVudDxEYXRhYmFzZT4odXJsLCBzZXJ2aWNlS2V5LCB7XHJcbiAgICAgIGF1dGg6IHsgcGVyc2lzdFNlc3Npb246IGZhbHNlIH0sXHJcbiAgICB9KVxyXG4gIDogbnVsbDtcclxuIl0sIm5hbWVzIjpbImNyZWF0ZUNsaWVudCIsInVybCIsInByb2Nlc3MiLCJlbnYiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwiLCJzZXJ2aWNlS2V5IiwiU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSIsImNvbnNvbGUiLCJ3YXJuIiwic2VydmljZUNsaWVudCIsImF1dGgiLCJwZXJzaXN0U2Vzc2lvbiJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/supabase/service.ts\n");

/***/ }),

/***/ "(rsc)/./src/server/tenant-headers.ts":
/*!**************************************!*\
  !*** ./src/server/tenant-headers.ts ***!
  \**************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   getTenantHeaderInfo: () => (/* binding */ getTenantHeaderInfo)\n/* harmony export */ });\nconst DEV_TENANT_SLUG = process.env.NEXT_PUBLIC_DEV_TENANT_SLUG ?? \"tenant_1\";\nfunction getTenantHeaderInfo(headerBag) {\n    const slug = headerBag.get(\"x-tenant-id\");\n    const internalId = headerBag.get(\"x-tenant-internal-id\");\n    const isDevBypass =  true && slug === DEV_TENANT_SLUG;\n    return {\n        slug,\n        internalId,\n        isDevBypass\n    };\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvc2VydmVyL3RlbmFudC1oZWFkZXJzLnRzIiwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxrQkFBa0JDLFFBQVFDLEdBQUcsQ0FBQ0MsMkJBQTJCLElBQUk7QUFFNUQsU0FBU0Msb0JBQW9CQyxTQUFrQjtJQUNwRCxNQUFNQyxPQUFPRCxVQUFVRSxHQUFHLENBQUM7SUFDM0IsTUFBTUMsYUFBYUgsVUFBVUUsR0FBRyxDQUFDO0lBQ2pDLE1BQU1FLGNBQWNSLEtBQXNDLElBQUlLLFNBQVNOO0lBQ3ZFLE9BQU87UUFBRU07UUFBTUU7UUFBWUM7SUFBWTtBQUN6QyIsInNvdXJjZXMiOlsid2VicGFjazovL2FnZW5kYXItYXBwLy4vc3JjL3NlcnZlci90ZW5hbnQtaGVhZGVycy50cz9mYjk5Il0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IERFVl9URU5BTlRfU0xVRyA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX0RFVl9URU5BTlRfU0xVRyA/PyBcInRlbmFudF8xXCI7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGVuYW50SGVhZGVySW5mbyhoZWFkZXJCYWc6IEhlYWRlcnMpIHtcclxuICBjb25zdCBzbHVnID0gaGVhZGVyQmFnLmdldChcIngtdGVuYW50LWlkXCIpO1xyXG4gIGNvbnN0IGludGVybmFsSWQgPSBoZWFkZXJCYWcuZ2V0KFwieC10ZW5hbnQtaW50ZXJuYWwtaWRcIik7XHJcbiAgY29uc3QgaXNEZXZCeXBhc3MgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gXCJkZXZlbG9wbWVudFwiICYmIHNsdWcgPT09IERFVl9URU5BTlRfU0xVRztcclxuICByZXR1cm4geyBzbHVnLCBpbnRlcm5hbElkLCBpc0RldkJ5cGFzcyB9O1xyXG59XHJcbiJdLCJuYW1lcyI6WyJERVZfVEVOQU5UX1NMVUciLCJwcm9jZXNzIiwiZW52IiwiTkVYVF9QVUJMSUNfREVWX1RFTkFOVF9TTFVHIiwiZ2V0VGVuYW50SGVhZGVySW5mbyIsImhlYWRlckJhZyIsInNsdWciLCJnZXQiLCJpbnRlcm5hbElkIiwiaXNEZXZCeXBhc3MiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./src/server/tenant-headers.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/@supabase","vendor-chunks/next","vendor-chunks/tslib","vendor-chunks/iceberg-js","vendor-chunks/set-cookie-parser","vendor-chunks/jose","vendor-chunks/date-fns"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fappointments%2F%5Bid%5D%2Froute&page=%2Fapi%2Fappointments%2F%5Bid%5D%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fappointments%2F%5Bid%5D%2Froute.ts&appDir=C%3A%5CUsers%5Crementeriama%5CDownloads%5CCode%5CAgend.ar%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Crementeriama%5CDownloads%5CCode%5CAgend.ar&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();