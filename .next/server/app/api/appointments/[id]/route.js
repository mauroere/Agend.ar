"use strict";(()=>{var e={};e.id=2499,e.ids=[2499],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4180:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>h,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g});var r={};n.r(r),n.d(r,{PATCH:()=>m});var i=n(9303),a=n(8716),s=n(670),o=n(7070),u=n(1784),d=n(1155),l=n(259),p=n(3837),c=n(5072);async function m(e,{params:t}){let n=(0,p.j)(),{data:r}=await n.auth.getSession(),i=r.session?.user?.app_metadata?.tenant_id??r.session?.user?.user_metadata?.tenant_id??null,a=e.headers.get("x-tenant-id"),s=i??a;if(!r.session||!s)return o.NextResponse.json({error:"Unauthorized"},{status:401});if(a&&i&&a!==i)return o.NextResponse.json({error:"Tenant mismatch"},{status:403});let m=c.o??n,_=t.id;if(!_)return o.NextResponse.json({error:"Missing appointment id"},{status:400});let f=await e.json(),{patient:g,phone:v,start:h,duration:x,service:b,notes:j,location_id:y,serviceId:w,providerId:q}=f??{},N=f??{},S=Object.prototype.hasOwnProperty.call(N,"serviceId"),R=Object.prototype.hasOwnProperty.call(N,"providerId");if(!g||!v||!h)return o.NextResponse.json({error:"Faltan datos requeridos"},{status:400});let{data:O,error:P}=await m.from("agenda_appointments").select("id, tenant_id, location_id, start_at, end_at, status, patient_id, service_id, service_name, service_snapshot, provider_id").eq("id",_).eq("tenant_id",s).single();if(P||!O)return o.NextResponse.json({error:"Turno no encontrado"},{status:404});let A=new Date(h);if(!Number.isFinite(A.getTime()))return o.NextResponse.json({error:"Fecha inv\xe1lida"},{status:400});let D=(0,u.X)(new Date(O.end_at),new Date(O.start_at)),E=v.startsWith("+")?v:`+${v}`,k=S?w??null:O.service_id??null,C=null;if(k){let{data:e,error:t}=await m.from("agenda_services").select("id, tenant_id, name, description, duration_minutes, price_minor_units, currency, color, active").eq("tenant_id",s).eq("id",k).maybeSingle();if(t||!e)return o.NextResponse.json({error:"Servicio inv\xe1lido"},{status:400});if(!e.active)return o.NextResponse.json({error:"El servicio est\xe1 pausado"},{status:400});C=e}let I=R?q??null:O.provider_id??null,F=null;if(I){let{data:e,error:t}=await m.from("agenda_providers").select("id, tenant_id, full_name, active, default_location_id").eq("tenant_id",s).eq("id",I).maybeSingle();if(t||!e)return o.NextResponse.json({error:"Profesional inv\xe1lido"},{status:400});if(!e.active)return o.NextResponse.json({error:"El profesional est\xe1 pausado"},{status:400});F=e}let T=Number(x??C?.duration_minutes??D??30),M=Math.max(5,Number.isFinite(T)?T:D||30),U=(0,d.m)(A,M),{data:z}=await m.from("agenda_patients").select("id").eq("tenant_id",s).eq("phone_e164",E).maybeSingle(),L=z?.id??O.patient_id??null;if(L)await m.from("agenda_patients").update({full_name:g}).eq("id",L).eq("tenant_id",s);else{let{data:e,error:t}=await m.from("agenda_patients").insert({tenant_id:s,full_name:g,phone_e164:E,opt_out:!1}).select("id").single();if(t)return o.NextResponse.json({error:t.message},{status:400});L=e.id}let Q=y??O.location_id??F?.default_location_id??null,H="America/Argentina/Buenos_Aires",J=0,X={};if(Q){let{data:e}=await m.from("agenda_locations").select("id, timezone, buffer_minutes, business_hours").eq("tenant_id",s).eq("id",Q).maybeSingle();e&&(H=e.timezone,J=e.buffer_minutes??0,X=e.business_hours??{})}if(!Q){let{data:e}=await m.from("agenda_locations").select("id, timezone, buffer_minutes, business_hours").eq("tenant_id",s).order("name",{ascending:!0}).limit(1).maybeSingle();e&&(Q=e.id,H=e.timezone,J=e.buffer_minutes??0,X=e.business_hours??{})}if(!Q)return o.NextResponse.json({error:"Debe crear una ubicaci\xf3n primero"},{status:400});if(!(0,l.U)({start:A,end:U,businessHours:X,timeZone:H}))return o.NextResponse.json({error:"Fuera del horario de atenci\xf3n"},{status:400});let B=(0,d.m)(A,-J),Y=(0,d.m)(U,J),$=m.from("agenda_appointments").select("id").eq("tenant_id",s).eq("location_id",Q).neq("status","canceled").neq("id",_).lt("start_at",Y.toISOString()).gt("end_at",B.toISOString());I&&($=$.or(`provider_id.eq.${I},provider_id.is.null`));let{data:G,error:K}=await $.limit(1);if(K)return o.NextResponse.json({error:K.message},{status:400});if(G&&G.length>0)return o.NextResponse.json({error:"Ya hay un turno en ese horario"},{status:409});let V=C?{id:C.id,name:C.name,description:C.description,duration_minutes:C.duration_minutes,price_minor_units:C.price_minor_units,currency:C.currency,color:C.color}:S?null:O.service_snapshot,W="string"==typeof b&&b.trim().length>0?b.trim():null,Z=O.service_name??null;S?Z=C?.name??W:W&&(Z=W);let ee={location_id:Q,patient_id:L,start_at:A.toISOString(),end_at:U.toISOString(),service_id:k,provider_id:I,service_name:Z,service_snapshot:V,internal_notes:j??null},{error:et,data:en}=await m.from("agenda_appointments").update(ee).eq("id",_).eq("tenant_id",s).select("id, start_at, end_at, status").single();return et?o.NextResponse.json({error:et.message},{status:400}):o.NextResponse.json({ok:!0,appointment:en})}let _=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/appointments/[id]/route",pathname:"/api/appointments/[id]",filename:"route",bundlePath:"app/api/appointments/[id]/route"},resolvedPagePath:"C:\\Users\\rementeriama\\Downloads\\Code\\Agend.ar\\src\\app\\api\\appointments\\[id]\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:v}=_,h="/api/appointments/[id]/route";function x(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}},259:(e,t,n)=>{function r(e){let{start:t,end:n,businessHours:r,timeZone:i}=e,a=new Intl.DateTimeFormat("en-US",{timeZone:i,weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}),s=Object.fromEntries(a.formatToParts(t).map(e=>[e.type,e.value])),o=Object.fromEntries(a.formatToParts(n).map(e=>[e.type,e.value])),u=(s.weekday??"").slice(0,3).toLowerCase();if(u!==(o.weekday??"").slice(0,3).toLowerCase())return!1;let d=r?.[u];if(!d||0===d.length)return!1;let l=(e,t)=>60*Number(e)+Number(t),p=l(s.hour??"0",s.minute??"0"),c=l(o.hour??"0",o.minute??"0");return d.some(([e,t])=>{let[n,r]=e.split(":"),[i,a]=t.split(":"),s=l(n,r),o=l(i,a);return p>=s&&c<=o})}n.d(t,{U:()=>r})},3837:(e,t,n)=>{n.d(t,{j:()=>a});var r=n(1615),i=n(344);function a(){return(0,i.createRouteHandlerClient)({cookies:r.cookies})}},5072:(e,t,n)=>{n.d(t,{o:()=>s});var r=n(7857);let i="https://oaxielrsiogvnxradtsw.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;i&&a||console.warn("Supabase service client is not fully configured.");let s=i&&a?(0,r.eI)(i,a,{auth:{persistSession:!1}}):null},1459:(e,t,n)=>{n.d(t,{n:()=>a});var r=n(9109),i=n(4549);function a(e,t){let n=+(0,r.Q)(e);return(0,i.L)(e,n+t)}},1155:(e,t,n)=>{n.d(t,{m:()=>a});var r=n(1459),i=n(2313);function a(e,t){return(0,r.n)(e,t*i.yJ)}},2313:(e,t,n)=>{n.d(t,{dP:()=>i,jE:()=>r,vh:()=>s,yJ:()=>a});let r=6048e5,i=864e5,a=6e4,s=36e5},4549:(e,t,n)=>{function r(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}n.d(t,{L:()=>r})},1784:(e,t,n)=>{n.d(t,{X:()=>a});var r=n(2313),i=n(9109);function a(e,t,n){var a;let s=(+(0,i.Q)(e)-+(0,i.Q)(t))/r.yJ;return(a=n?.roundingMethod,e=>{let t=(a?Math[a]:Math.trunc)(e);return 0===t?0:t})(s)}},9109:(e,t,n)=>{function r(e){let t=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===t?new e.constructor(+e):new Date("number"==typeof e||"[object Number]"===t||"string"==typeof e||"[object String]"===t?e:NaN)}n.d(t,{Q:()=>r})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[9276,7857,5972,958],()=>n(4180));module.exports=r})();