"use strict";(()=>{var e={};e.id=8487,e.ids=[8487],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4138:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>x,staticGenerationAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{GET:()=>l,POST:()=>p});var s=r(9303),a=r(8716),o=r(670),i=r(7070),u=r(3719);async function l(e){let t=await (0,u.o)(e);if("error"in t)return t.error;let{db:r,tenantId:n}=t,s=e.nextUrl.searchParams,a=s.get("q"),o=Math.min(Number(s.get("limit")??10),50),l=r.from("agenda_patients").select("id, full_name, phone_e164").eq("tenant_id",n).order("full_name",{ascending:!0}).limit(o);a&&(l=l.or(`full_name.ilike.%${a}%,phone_e164.ilike.%${a}%`));let{data:p,error:d}=await l;return d?i.NextResponse.json({error:d.message},{status:500}):i.NextResponse.json({patients:p})}async function p(e){let t=await (0,u.o)(e);if("error"in t)return t.error;let{db:r,tenantId:n}=t;try{let{fullName:t,phone:s,notes:a}=await e.json()??{};if(!t||!s)return i.NextResponse.json({error:"Nombre y tel\xe9fono son requeridos"},{status:400});let o=s.trim().startsWith("+")?s.trim():`+${s.trim()}`,{data:u}=await r.from("agenda_patients").select("id").eq("tenant_id",n).eq("phone_e164",o).maybeSingle();if(u)return i.NextResponse.json({error:"Ya existe un paciente con ese tel\xe9fono"},{status:409});let{data:l,error:p}=await r.from("agenda_patients").insert({tenant_id:n,full_name:t,phone_e164:o,notes:a||null,opt_out:!1}).select().single();if(p)return console.error("Error inserting patient:",p),i.NextResponse.json({error:`Error DB: ${p.message}`},{status:400});return i.NextResponse.json({patient:l})}catch(e){return console.error("API Error:",e),i.NextResponse.json({error:"Internal Server Error"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/patients/route",pathname:"/api/patients",filename:"route",bundlePath:"app/api/patients/route"},resolvedPagePath:"C:\\Users\\rementeriama\\Downloads\\Code\\Agend.ar\\src\\app\\api\\patients\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:x}=d,f="/api/patients/route";function g(){return(0,o.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:m})}},3837:(e,t,r)=>{r.d(t,{j:()=>a});var n=r(1615),s=r(344);function a(){return(0,s.createRouteHandlerClient)({cookies:n.cookies})}},5072:(e,t,r)=>{r.d(t,{o:()=>o});var n=r(7857);let s="https://oaxielrsiogvnxradtsw.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;s&&a||console.warn("Supabase service client is not fully configured.");let o=s&&a?(0,n.eI)(s,a,{auth:{persistSession:!1}}):null},3719:(e,t,r)=>{r.d(t,{o:()=>o});var n=r(7070),s=r(3837),a=r(5072);async function o(e){let t=(0,s.j)(),{data:{session:r}}=await t.auth.getSession();if(!r)return{error:n.NextResponse.json({error:"Unauthorized"},{status:401})};let o=a.o??t,i=r.user.app_metadata?.tenant_id??r.user.user_metadata?.tenant_id??null;if(!i){let{data:e}=await o.from("agenda_users").select("tenant_id").eq("id",r.user.id).maybeSingle();e&&(i=e.tenant_id)}let u=e.headers.get("x-tenant-id"),l=i??u;return l?u&&i&&u!==i?{error:n.NextResponse.json({error:"Tenant mismatch"},{status:403})}:{supabase:t,db:o,tenantId:l,session:r}:{error:n.NextResponse.json({error:"Unauthorized"},{status:401})}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,7857,5972,958],()=>r(4138));module.exports=n})();