"use strict";(()=>{var e={};e.id=8289,e.ids=[8289],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},224:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>x,staticGenerationAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{DELETE:()=>p,PATCH:()=>d});var a=r(9303),s=r(8716),o=r(670),i=r(7070),u=r(3719);async function d(e,{params:t}){let r=await (0,u.o)(e);if("error"in r)return r.error;let{db:n,tenantId:a}=r,s=await e.json().catch(()=>null);if(!s)return i.NextResponse.json({error:"Cuerpo inv\xe1lido"},{status:400});let{fullName:o,phone:d,optOut:p,notes:l}=s;if(!o&&!d&&void 0===p&&void 0===l)return i.NextResponse.json({error:"No hay cambios para aplicar"},{status:400});let c={};if(o&&(c.full_name=o),"boolean"==typeof p&&(c.opt_out=p),void 0!==l){let e="string"==typeof l?l.trim():l;c.notes=e||null}if(d){let e=d.trim().startsWith("+")?d.trim():`+${d.trim()}`,{data:r}=await n.from("agenda_patients").select("id").eq("tenant_id",a).eq("phone_e164",e).neq("id",t.id).maybeSingle();if(r)return i.NextResponse.json({error:"Otra ficha ya usa ese tel\xe9fono"},{status:409});c.phone_e164=e}if(0===Object.keys(c).length)return i.NextResponse.json({error:"No hay campos v\xe1lidos"},{status:400});let{data:m,error:x}=await n.from("agenda_patients").update(c).eq("tenant_id",a).eq("id",t.id).select().single();return x?(console.error("Error updating patient",x),i.NextResponse.json({error:x.message},{status:400})):m?i.NextResponse.json({patient:m}):i.NextResponse.json({error:"Paciente no encontrado"},{status:404})}async function p(e,{params:t}){let r=await (0,u.o)(e);if("error"in r)return r.error;let{db:n,tenantId:a}=r,{data:s}=await n.from("agenda_appointments").select("id").eq("tenant_id",a).eq("patient_id",t.id).gte("start_at",new Date().toISOString()).limit(1);if(Array.isArray(s)&&s.length>0)return i.NextResponse.json({error:"No pod\xe9s eliminar pacientes con turnos futuros"},{status:409});let{error:o}=await n.from("agenda_patients").delete().eq("tenant_id",a).eq("id",t.id);return o?(console.error("Error deleting patient",o),i.NextResponse.json({error:o.message},{status:400})):i.NextResponse.json({ok:!0})}let l=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/patients/[id]/route",pathname:"/api/patients/[id]",filename:"route",bundlePath:"app/api/patients/[id]/route"},resolvedPagePath:"C:\\Users\\rementeriama\\Downloads\\Code\\Agend.ar\\src\\app\\api\\patients\\[id]\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:x}=l,f="/api/patients/[id]/route";function g(){return(0,o.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:m})}},3837:(e,t,r)=>{r.d(t,{j:()=>s});var n=r(1615),a=r(344);function s(){return(0,a.createRouteHandlerClient)({cookies:n.cookies})}},5072:(e,t,r)=>{r.d(t,{o:()=>o});var n=r(7857);let a="https://oaxielrsiogvnxradtsw.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY;a&&s||console.warn("Supabase service client is not fully configured.");let o=a&&s?(0,n.eI)(a,s,{auth:{persistSession:!1}}):null},3719:(e,t,r)=>{r.d(t,{o:()=>o});var n=r(7070),a=r(3837),s=r(5072);async function o(e){let t=(0,a.j)(),{data:{session:r}}=await t.auth.getSession();if(!r)return{error:n.NextResponse.json({error:"Unauthorized"},{status:401})};let o=s.o??t,i=r.user.app_metadata?.tenant_id??r.user.user_metadata?.tenant_id??null;if(!i){let{data:e}=await o.from("agenda_users").select("tenant_id").eq("id",r.user.id).maybeSingle();e&&(i=e.tenant_id)}let u=e.headers.get("x-tenant-id"),d=i??u;return d?u&&i&&u!==i?{error:n.NextResponse.json({error:"Tenant mismatch"},{status:403})}:{supabase:t,db:o,tenantId:d,session:r}:{error:n.NextResponse.json({error:"Unauthorized"},{status:401})}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,7857,5972,958],()=>r(224));module.exports=n})();