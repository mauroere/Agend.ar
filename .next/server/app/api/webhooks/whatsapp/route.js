"use strict";(()=>{var e={};e.id=5162,e.ids=[5162],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6259:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>_,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var n={};a.r(n),a.d(n,{GET:()=>m,POST:()=>f});var r=a(9303),s=a(8716),i=a(670),o=a(7070),d=a(5072),p=a(836),u=a(6651);async function l({tenantId:e,patientId:t,direction:a,type:n,status:r,waMessageId:s,payload:i}){d.o&&await d.o.from("agenda_message_log").insert({tenant_id:e,patient_id:t,direction:a,type:n,status:r,wa_message_id:s??null,payload_json:i})}async function c({tenantId:e,patientId:t,phone:a,text:n,credentials:r}){if(!d.o)return;let s=n.trim().toUpperCase(),i=async e=>{r&&await (0,p.n)({to:a,text:e,credentials:r})};if("STOP"===s){await d.o.from("agenda_patients").update({opt_out:!0,opt_out_at:new Date().toISOString()}).eq("id",t).eq("tenant_id",e),await l({tenantId:e,patientId:t,direction:"out",type:"opt_out_ack",status:"queued",payload:{text:"Opt-out"}}),await i("Listo, no te vamos a enviar m\xe1s recordatorios. Escrib\xed SI si quer\xe9s reactivar.");return}if(["1","2","3"].includes(s)){let a=await d.o.from("agenda_appointments").select("id, start_at, location_id").eq("patient_id",t).eq("tenant_id",e).gte("start_at",new Date().toISOString()).order("start_at",{ascending:!0}).limit(1),n=a.data?.[0];if(!n)return;"1"===s&&(await d.o.from("agenda_appointments").update({status:"confirmed"}).eq("id",n.id).eq("tenant_id",e),await i("\xa1Perfecto! Te esperamos.")),"3"===s&&(await d.o.from("agenda_appointments").update({status:"canceled"}).eq("id",n.id).eq("tenant_id",e),await i("Turno cancelado. Si quer\xe9s otro horario respond\xe9 SI.")),"2"===s&&(await d.o.from("agenda_appointments").update({status:"reschedule_requested"}).eq("id",n.id).eq("tenant_id",e),await i(`Ofrecemos 09:00, 11:30, 15:00. Respond\xe9 A/B/C para elegir o STOP para salir`))}}async function m(e){let t=new URL(e.url),a=t.searchParams.get("hub.mode"),n=t.searchParams.get("hub.verify_token"),r=t.searchParams.get("hub.challenge");return"subscribe"===a&&n&&r&&(d.o&&await (0,u.gQ)(d.o,n)||n===process.env.WHATSAPP_VERIFY_TOKEN)?new o.NextResponse(r,{status:200}):new o.NextResponse("forbidden",{status:403})}async function f(e){let t=d.o;if(!t)return console.error("Supabase service client unavailable for WhatsApp webhook"),o.NextResponse.json({error:"service_unavailable"},{status:500});let a=(await e.json()).entry??[],n=e.headers.get("x-tenant-id")??void 0,r=new Map,s=new Map,i=async e=>{let a=n??e?.tenant_id;if(a)return r.has(a)||r.set(a,await (0,u.XW)(t,a)),{tenantId:a,credentials:r.get(a)??null};let i=e?.phone_number_id;if(i){s.has(i)||s.set(i,await (0,u.$2)(t,i));let e=s.get(i);if(e)return r.set(e.tenantId,e.credentials),e}return null};for(let e of a)for(let a of e.changes??[]){let e=await i(a.value?.metadata??void 0);if(!e)continue;let{tenantId:n,credentials:r}=e;for(let e of a.value?.messages??[]){var p;let a=(p=e.from).startsWith("+")?p:`+${p}`,{data:s}=await t.from("agenda_patients").select("id, tenant_id, opt_out").eq("phone_e164",a).eq("tenant_id",n).single();s&&(await l({tenantId:n,patientId:s.id,direction:"in",type:e.type??null,status:e.status??"received",waMessageId:e.id,payload:e}),"text"===e.type&&await c({tenantId:n,patientId:s.id,phone:a,text:e.text?.body??"",credentials:r}))}}return o.NextResponse.json({ok:!0})}let _=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/whatsapp/route",pathname:"/api/webhooks/whatsapp",filename:"route",bundlePath:"app/api/webhooks/whatsapp/route"},resolvedPagePath:"C:\\Users\\rementeriama\\Downloads\\Code\\Agend.ar\\src\\app\\api\\webhooks\\whatsapp\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:w}=_,y="/api/webhooks/whatsapp/route";function v(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},5072:(e,t,a)=>{a.d(t,{o:()=>i});var n=a(7857);let r="https://oaxielrsiogvnxradtsw.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY;r&&s||console.warn("Supabase service client is not fully configured.");let i=r&&s?(0,n.eI)(r,s,{auth:{persistSession:!1}}):null},836:(e,t,a)=>{a.d(t,{D:()=>i,n:()=>o});var n=a(1067);let r=n.Ry({name:n.Z_(),language:n.Ry({code:n.Z_()}),components:n.IX(n.Yj()).optional()});async function s({credentials:e,path:t,init:a}){let{accessToken:n,phoneNumberId:r}=e;if(!n||!r)throw Error("WhatsApp credentials missing");let s=await fetch(`https://graph.facebook.com/v18.0/${r}/${t}`,{...a,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`,...a.headers}});if(!s.ok){let e=await s.text();throw Error(`WhatsApp API error: ${s.status} ${e}`)}return s.json()}async function i({to:e,template:t,variables:a=[],languageCode:n="es",nameOverride:i,credentials:o}){return s({credentials:o,path:"messages",init:{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"template",template:{...r.parse({name:i??t,language:{code:n}}),components:[{type:"body",parameters:a.map(e=>({type:"text",text:e}))}]}})}})}async function o({to:e,text:t,credentials:a}){return s({credentials:a,path:"messages",init:{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"text",text:{body:t}})}})}},6651:(e,t,a)=>{a.d(t,{$2:()=>o,OC:()=>p,XW:()=>i,gQ:()=>d});let n="meta_whatsapp";function r(e){if(!e||"object"!=typeof e)return null;let t="string"==typeof e.phoneNumberId?e.phoneNumberId:void 0,a="string"==typeof e.accessToken?e.accessToken:void 0,n="string"==typeof e.businessAccountId?e.businessAccountId:null,r="string"==typeof e.verifyToken?e.verifyToken:null;return t&&a?{phoneNumberId:t,accessToken:a,businessAccountId:n,verifyToken:r}:null}async function s(e,t){let a=e.from("agenda_integrations").select("id, tenant_id, provider, credentials, created_at, updated_at").eq("provider",n).limit(1);for(let[e,n]of Object.entries(t))a=a.filter(e,"eq",n);let{data:s,error:i}=await a.maybeSingle();if(i||!s)return null;let o=r(s.credentials);return o?{...s,credentials_parsed:o}:null}async function i(e,t){let a=await e.from("agenda_integrations").select("tenant_id, provider, credentials, created_at, updated_at").eq("tenant_id",t).eq("provider",n).maybeSingle();return a.error||!a.data?null:r(a.data.credentials)}async function o(e,t){let a=await s(e,{"credentials->>phoneNumberId":t});return a?{tenantId:a.tenant_id,credentials:a.credentials_parsed}:null}async function d(e,t){let a=await s(e,{"credentials->>verifyToken":t});return a?{tenantId:a.tenant_id,credentials:a.credentials_parsed}:null}async function p(e,t){let a=new Map,{data:n}=await e.from("agenda_message_templates").select("name, meta_template_name, status").eq("tenant_id",t);for(let e of n??[])a.set(e.name,{metaTemplateName:e.meta_template_name,status:e.status});return a}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[9276,7857,5972,1067],()=>a(6259));module.exports=n})();