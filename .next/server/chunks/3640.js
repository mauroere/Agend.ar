"use strict";exports.id=3640,exports.ids=[3640],exports.modules={40:(e,t,n)=>{function a(e,t,n={}){let a={level:e,message:t,timestamp:new Date().toISOString(),...n};return console["error"===e?"error":"warn"===e?"warn":"log"](JSON.stringify(a)),a}function i(e,t){return a("info",e,t)}function r(e,t){return a("error",e,t)}n.d(t,{H:()=>r,PN:()=>i})},59:(e,t,n)=>{n.d(t,{Q:()=>i,g:()=>a});let a={appointmentCreated:"appointment_created",reminder24h:"reminder_24h",reminder2h:"reminder_2h",waitlistOffer:"waitlist_offer"},i={[a.appointmentCreated]:"Hola {{1}}, agendamos tu turno para {{2}} a las {{3}} en {{4}}. Respond\xe9 1 Confirmar \xb7 2 Reprogramar \xb7 3 Cancelar \xb7 STOP para salir.",[a.reminder24h]:"Recordatorio {{1}} ma\xf1ana {{2}}. Respond\xe9 1 Confirmar \xb7 2 Reprogramar \xb7 3 Cancelar \xb7 STOP.",[a.reminder2h]:"Nos vemos hoy {{1}} a las {{2}}. Si necesit\xe1s moverlo respond\xe9 2, cancelar 3.",[a.waitlistOffer]:"Se liber\xf3 un turno {{1}} a las {{2}}. Respond\xe9 SI para tomarlo o STOP para salir."}},259:(e,t,n)=>{function a(e){let{start:t,end:n,businessHours:a,timeZone:i}=e,r=new Intl.DateTimeFormat("en-US",{timeZone:i,weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}),o=Object.fromEntries(r.formatToParts(t).map(e=>[e.type,e.value])),s=Object.fromEntries(r.formatToParts(n).map(e=>[e.type,e.value])),l=(o.weekday??"").slice(0,3).toLowerCase();if(l!==(s.weekday??"").slice(0,3).toLowerCase())return!1;let d=a?.[l];if(!d||0===d.length)return!1;let u=(e,t)=>60*Number(e)+Number(t),m=u(o.hour??"0",o.minute??"0"),c=u(s.hour??"0",s.minute??"0");return d.some(([e,t])=>{let[n,a]=e.split(":"),[i,r]=t.split(":"),o=u(n,a),s=u(i,r);return m>=o&&c<=s})}n.d(t,{U:()=>a})},5072:(e,t,n)=>{n.d(t,{o:()=>o});var a=n(7857);let i="https://oaxielrsiogvnxradtsw.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;i&&r||console.warn("Supabase service client is not fully configured.");let o=i&&r?(0,a.eI)(i,r,{auth:{persistSession:!1}}):null},836:(e,t,n)=>{n.d(t,{D:()=>o,n:()=>s});var a=n(1067);let i=a.Ry({name:a.Z_(),language:a.Ry({code:a.Z_()}),components:a.IX(a.Yj()).optional()});async function r({credentials:e,path:t,init:n}){let{accessToken:a,phoneNumberId:i}=e;if(!a||!i)throw Error("WhatsApp credentials missing");let r=await fetch(`https://graph.facebook.com/v18.0/${i}/${t}`,{...n,headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`,...n.headers}});if(!r.ok){let e=await r.text();throw Error(`WhatsApp API error: ${r.status} ${e}`)}return r.json()}async function o({to:e,template:t,variables:n=[],languageCode:a="es",nameOverride:o,credentials:s}){return r({credentials:s,path:"messages",init:{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"template",template:{...i.parse({name:o??t,language:{code:a}}),components:[{type:"body",parameters:n.map(e=>({type:"text",text:e}))}]}})}})}async function s({to:e,text:t,credentials:n}){return r({credentials:n,path:"messages",init:{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"text",text:{body:t}})}})}},9045:(e,t,n)=>{n.d(t,{n:()=>u,s:()=>d});var a=n(1155),i=n(259),r=n(836),o=n(59),s=n(6651),l=n(40);class d extends Error{constructor(e,t=400){super(e),this.status=t}}async function u(e){let{db:t,tenantId:n,input:u,sendNotifications:m=!0}=e,{patient:c,phone:p,start:f,duration:_,serviceName:g,notes:w,locationId:h,serviceId:y,providerId:b}=u;if(!c||!p||!f)throw new d("Missing required fields",400);let v=new Date(f);if(!Number.isFinite(v.getTime()))throw new d("Invalid start date",400);let S=p.startsWith("+")?p:`+${p}`,O=null;if(y){let{data:e,error:a}=await t.from("agenda_services").select("id, tenant_id, name, description, duration_minutes, price_minor_units, currency, color, active").eq("tenant_id",n).eq("id",y).maybeSingle();if(a||!e)throw new d("Servicio inv\xe1lido",400);if(!e.active)throw new d("El servicio est\xe1 pausado",400);O=e}let q=null;if(b){let{data:e,error:a}=await t.from("agenda_providers").select("id, tenant_id, full_name, active, default_location_id").eq("tenant_id",n).eq("id",b).maybeSingle();if(a||!e)throw new d("Profesional inv\xe1lido",400);if(!e.active)throw new d("El profesional est\xe1 pausado",400);q=e}let I=Number(_??O?.duration_minutes??30),N=Math.max(5,Number.isFinite(I)?I:30),T=(0,a.m)(v,N),{data:C}=await t.from("agenda_patients").select("id").eq("tenant_id",n).eq("phone_e164",S).maybeSingle(),A=C?.id??null;if(A)await t.from("agenda_patients").update({full_name:c}).eq("id",A).eq("tenant_id",n);else{let{data:e,error:a}=await t.from("agenda_patients").insert({tenant_id:n,full_name:c,phone_e164:S,opt_out:!1}).select("id").single();if(a)throw new d(a.message,400);A=e.id}let E=h??q?.default_location_id??null,P="Consultorio",j="America/Argentina/Buenos_Aires",x=0,D={},R=e=>{e?(E=e.id,P=e.name,j=e.timezone,x=e.buffer_minutes??0,D=e.business_hours??{}):E=null};if(E){let{data:e}=await t.from("agenda_locations").select("id, name, timezone, buffer_minutes, business_hours").eq("tenant_id",n).eq("id",E).maybeSingle();R(e??null)}if(!E){let{data:e}=await t.from("agenda_locations").select("id, name, timezone, buffer_minutes, business_hours").eq("tenant_id",n).order("name",{ascending:!0}).limit(1).maybeSingle();R(e??null)}if(!E)throw new d("Debe crear una ubicaci\xf3n primero",400);if(!(0,i.U)({start:v,end:T,businessHours:D,timeZone:j}))throw new d("Fuera del horario de atenci\xf3n",400);let k=(0,a.m)(v,-x),$=(0,a.m)(T,x),L=t.from("agenda_appointments").select("id").eq("tenant_id",n).eq("location_id",E).neq("status","canceled").lt("start_at",$.toISOString()).gt("end_at",k.toISOString());q?.id&&(L=L.or(`provider_id.eq.${q.id},provider_id.is.null`));let{data:W,error:J}=await L.limit(1);if(J)throw new d(J.message,400);if(W&&W.length>0)throw new d("Ya hay un turno en ese horario",409);let z=O?{id:O.id,name:O.name,description:O.description,duration_minutes:O.duration_minutes,price_minor_units:O.price_minor_units,currency:O.currency,color:O.color}:null,F=O?.name??(g?.trim().length?g?.trim():null),Q={tenant_id:n,location_id:E,patient_id:A,start_at:v.toISOString(),end_at:T.toISOString(),status:"pending",service_id:O?.id??null,provider_id:q?.id??null,service_name:F,service_snapshot:z,internal_notes:w??null},{error:U,data:B}=await t.from("agenda_appointments").insert(Q).select("id, start_at, end_at, status").single();if(U)throw new d(U.message,400);if(m)try{let[e,a]=await Promise.all([(0,s.XW)(t,n),(0,s.OC)(t,n)]);if(!e)throw Error("WhatsApp integration missing for tenant");let i=a.get(o.g.appointmentCreated)?.metaTemplateName??null;await (0,r.D)({to:S,template:o.g.appointmentCreated,variables:[c,v.toLocaleDateString("es-AR"),v.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"}),P],nameOverride:i,credentials:e}),await t.from("agenda_message_log").insert({tenant_id:n,patient_id:A,appointment_id:B.id,direction:"out",type:o.g.appointmentCreated,status:"sent"}),(0,l.PN)("appointment.created_notification_sent",{tenant_id:n,appointment_id:B.id,patient_id:A})}catch(e){(0,l.H)("appointment.created_notification_failed",{tenant_id:n,appointment_id:B.id,error:e?.message??String(e)})}return{appointment:B}}},6651:(e,t,n)=>{n.d(t,{$2:()=>s,OC:()=>d,XW:()=>o,gQ:()=>l});let a="meta_whatsapp";function i(e){if(!e||"object"!=typeof e)return null;let t="string"==typeof e.phoneNumberId?e.phoneNumberId:void 0,n="string"==typeof e.accessToken?e.accessToken:void 0,a="string"==typeof e.businessAccountId?e.businessAccountId:null,i="string"==typeof e.verifyToken?e.verifyToken:null;return t&&n?{phoneNumberId:t,accessToken:n,businessAccountId:a,verifyToken:i}:null}async function r(e,t){let n=e.from("agenda_integrations").select("id, tenant_id, provider, credentials, created_at, updated_at").eq("provider",a).limit(1);for(let[e,a]of Object.entries(t))n=n.filter(e,"eq",a);let{data:r,error:o}=await n.maybeSingle();if(o||!r)return null;let s=i(r.credentials);return s?{...r,credentials_parsed:s}:null}async function o(e,t){let n=await e.from("agenda_integrations").select("tenant_id, provider, credentials, created_at, updated_at").eq("tenant_id",t).eq("provider",a).maybeSingle();return n.error||!n.data?null:i(n.data.credentials)}async function s(e,t){let n=await r(e,{"credentials->>phoneNumberId":t});return n?{tenantId:n.tenant_id,credentials:n.credentials_parsed}:null}async function l(e,t){let n=await r(e,{"credentials->>verifyToken":t});return n?{tenantId:n.tenant_id,credentials:n.credentials_parsed}:null}async function d(e,t){let n=new Map,{data:a}=await e.from("agenda_message_templates").select("name, meta_template_name, status").eq("tenant_id",t);for(let e of a??[])n.set(e.name,{metaTemplateName:e.meta_template_name,status:e.status});return n}},1459:(e,t,n)=>{n.d(t,{n:()=>r});var a=n(9109),i=n(4549);function r(e,t){let n=+(0,a.Q)(e);return(0,i.L)(e,n+t)}},1155:(e,t,n)=>{n.d(t,{m:()=>r});var a=n(1459),i=n(2313);function r(e,t){return(0,a.n)(e,t*i.yJ)}},2313:(e,t,n)=>{n.d(t,{dP:()=>i,jE:()=>a,vh:()=>o,yJ:()=>r});let a=6048e5,i=864e5,r=6e4,o=36e5},4549:(e,t,n)=>{function a(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}n.d(t,{L:()=>a})},9109:(e,t,n)=>{function a(e){let t=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===t?new e.constructor(+e):new Date("number"==typeof e||"[object Number]"===t||"string"==typeof e||"[object String]"===t?e:NaN)}n.d(t,{Q:()=>a})}};