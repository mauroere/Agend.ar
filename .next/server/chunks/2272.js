"use strict";exports.id=2272,exports.ids=[2272],exports.modules={3405:(e,t,n)=>{n.d(t,{kA:()=>r,lD:()=>a});let a=["pending","confirmed","reschedule_requested","canceled","completed","no_show"],r="x-cron-secret"},4730:(e,t,n)=>{n.d(t,{r:()=>r});var a=n(3405);function r(e){let t=process.env.CRON_SECRET;if(!t)throw Error("CRON_SECRET is not configured");if(e.get(a.kA)!==t)throw Error("Invalid cron secret")}},4007:(e,t,n)=>{n.d(t,{Q:()=>c});var a=n(3229),r=n(1784),i=n(5072),o=n(836),s=n(59),d=n(6651),l=n(40);async function c({hoursAhead:e}){if(!i.o)throw Error("Supabase service client unavailable");let t=new Date,n=(0,a.T)(t,e-.25),c=(0,a.T)(t,e+.25),{data:p,error:u}=await i.o.from("agenda_appointments").select("id, tenant_id, patient_id, start_at, status, agenda_patients:patient_id(full_name, phone_e164, opt_out)").eq("status","confirmed").gte("start_at",n.toISOString()).lte("start_at",c.toISOString()).returns();if(u)throw u;(0,l.PN)("reminder.fetched",{job:"reminder",payload:{hoursAhead:e,count:p?.length??0}});let m=new Map,_=new Map;for(let n of p??[]){let a=n.agenda_patients;if(!a||a.opt_out)continue;let c=(0,r.X)(new Date(n.start_at),t);if(c<60*e-20||c>60*e+20)continue;let{data:p}=await i.o.from("agenda_message_log").select("id").eq("appointment_id",n.id).eq("type",24===e?s.g.reminder24h:s.g.reminder2h).maybeSingle();if(p)continue;let u=24===e?s.g.reminder24h:s.g.reminder2h,[f,g]=await Promise.all([(async()=>(m.has(n.tenant_id)||m.set(n.tenant_id,await (0,d.XW)(i.o,n.tenant_id)),m.get(n.tenant_id)??null))(),(async()=>(_.has(n.tenant_id)||_.set(n.tenant_id,await (0,d.OC)(i.o,n.tenant_id)),_.get(n.tenant_id)))()]);if(!f){(0,l.H)("reminder.missing_credentials",{job:"reminder",tenant_id:n.tenant_id,appointment_id:n.id});continue}let h=g?.get(u)?.metaTemplateName??null;try{await (0,o.D)({to:a.phone_e164,template:u,variables:[a.full_name,new Date(n.start_at).toLocaleString("es-AR")],nameOverride:h,credentials:f}),await i.o.from("agenda_message_log").insert({tenant_id:n.tenant_id,patient_id:n.patient_id,appointment_id:n.id,direction:"out",type:u,status:"sent",payload_json:{hoursAhead:e}}),(0,l.PN)("reminder.sent",{job:"reminder",tenant_id:n.tenant_id,patient_id:n.patient_id,appointment_id:n.id,payload:{hoursAhead:e}})}catch(e){(0,l.H)("reminder.failed",{job:"reminder",tenant_id:n.tenant_id,patient_id:n.patient_id,appointment_id:n.id,error:e?.message??String(e)})}}}},40:(e,t,n)=>{function a(e,t,n={}){let a={level:e,message:t,timestamp:new Date().toISOString(),...n};return console["error"===e?"error":"warn"===e?"warn":"log"](JSON.stringify(a)),a}function r(e,t){return a("info",e,t)}function i(e,t){return a("error",e,t)}n.d(t,{H:()=>i,PN:()=>r})},59:(e,t,n)=>{n.d(t,{Q:()=>r,g:()=>a});let a={appointmentCreated:"appointment_created",reminder24h:"reminder_24h",reminder2h:"reminder_2h",waitlistOffer:"waitlist_offer"},r={[a.appointmentCreated]:"Hola {{1}}, agendamos tu turno para {{2}} a las {{3}} en {{4}}. Respond\xe9 1 Confirmar \xb7 2 Reprogramar \xb7 3 Cancelar \xb7 STOP para salir.",[a.reminder24h]:"Recordatorio {{1}} ma\xf1ana {{2}}. Respond\xe9 1 Confirmar \xb7 2 Reprogramar \xb7 3 Cancelar \xb7 STOP.",[a.reminder2h]:"Nos vemos hoy {{1}} a las {{2}}. Si necesit\xe1s moverlo respond\xe9 2, cancelar 3.",[a.waitlistOffer]:"Se liber\xf3 un turno {{1}} a las {{2}}. Respond\xe9 SI para tomarlo o STOP para salir."}},5072:(e,t,n)=>{n.d(t,{o:()=>o});var a=n(7857);let r="https://oaxielrsiogvnxradtsw.supabase.co",i=process.env.SUPABASE_SERVICE_ROLE_KEY;r&&i||console.warn("Supabase service client is not fully configured.");let o=r&&i?(0,a.eI)(r,i,{auth:{persistSession:!1}}):null},836:(e,t,n)=>{n.d(t,{D:()=>o,n:()=>s});var a=n(1067);let r=a.Ry({name:a.Z_(),language:a.Ry({code:a.Z_()}),components:a.IX(a.Yj()).optional()});async function i({credentials:e,path:t,init:n}){let{accessToken:a,phoneNumberId:r}=e;if(!a||!r)throw Error("WhatsApp credentials missing");let i=await fetch(`https://graph.facebook.com/v18.0/${r}/${t}`,{...n,headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`,...n.headers}});if(!i.ok){let e=await i.text();throw Error(`WhatsApp API error: ${i.status} ${e}`)}return i.json()}async function o({to:e,template:t,variables:n=[],languageCode:a="es",nameOverride:o,credentials:s}){return i({credentials:s,path:"messages",init:{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"template",template:{...r.parse({name:o??t,language:{code:a}}),components:[{type:"body",parameters:n.map(e=>({type:"text",text:e}))}]}})}})}async function s({to:e,text:t,credentials:n}){return i({credentials:n,path:"messages",init:{method:"POST",body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"text",text:{body:t}})}})}},6651:(e,t,n)=>{n.d(t,{$2:()=>s,OC:()=>l,XW:()=>o,gQ:()=>d});let a="meta_whatsapp";function r(e){if(!e||"object"!=typeof e)return null;let t="string"==typeof e.phoneNumberId?e.phoneNumberId:void 0,n="string"==typeof e.accessToken?e.accessToken:void 0,a="string"==typeof e.businessAccountId?e.businessAccountId:null,r="string"==typeof e.verifyToken?e.verifyToken:null;return t&&n?{phoneNumberId:t,accessToken:n,businessAccountId:a,verifyToken:r}:null}async function i(e,t){let n=e.from("agenda_integrations").select("id, tenant_id, provider, credentials, created_at, updated_at").eq("provider",a).limit(1);for(let[e,a]of Object.entries(t))n=n.filter(e,"eq",a);let{data:i,error:o}=await n.maybeSingle();if(o||!i)return null;let s=r(i.credentials);return s?{...i,credentials_parsed:s}:null}async function o(e,t){let n=await e.from("agenda_integrations").select("tenant_id, provider, credentials, created_at, updated_at").eq("tenant_id",t).eq("provider",a).maybeSingle();return n.error||!n.data?null:r(n.data.credentials)}async function s(e,t){let n=await i(e,{"credentials->>phoneNumberId":t});return n?{tenantId:n.tenant_id,credentials:n.credentials_parsed}:null}async function d(e,t){let n=await i(e,{"credentials->>verifyToken":t});return n?{tenantId:n.tenant_id,credentials:n.credentials_parsed}:null}async function l(e,t){let n=new Map,{data:a}=await e.from("agenda_message_templates").select("name, meta_template_name, status").eq("tenant_id",t);for(let e of a??[])n.set(e.name,{metaTemplateName:e.meta_template_name,status:e.status});return n}},3229:(e,t,n)=>{n.d(t,{T:()=>i});var a=n(1459),r=n(2313);function i(e,t){return(0,a.n)(e,t*r.vh)}},1459:(e,t,n)=>{n.d(t,{n:()=>i});var a=n(9109),r=n(4549);function i(e,t){let n=+(0,a.Q)(e);return(0,r.L)(e,n+t)}},2313:(e,t,n)=>{n.d(t,{dP:()=>r,jE:()=>a,vh:()=>o,yJ:()=>i});let a=6048e5,r=864e5,i=6e4,o=36e5},4549:(e,t,n)=>{function a(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}n.d(t,{L:()=>a})},1784:(e,t,n)=>{n.d(t,{X:()=>i});var a=n(2313),r=n(9109);function i(e,t,n){var i;let o=(+(0,r.Q)(e)-+(0,r.Q)(t))/a.yJ;return(i=n?.roundingMethod,e=>{let t=(i?Math[i]:Math.trunc)(e);return 0===t?0:t})(o)}},9109:(e,t,n)=>{function a(e){let t=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===t?new e.constructor(+e):new Date("number"==typeof e||"[object Number]"===t||"string"==typeof e||"[object String]"===t?e:NaN)}n.d(t,{Q:()=>a})}};